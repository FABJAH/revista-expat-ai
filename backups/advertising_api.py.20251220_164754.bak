"""
Backend API para Luna Advertising Sales Bot
Endpoints para servir las respuestas del bot a través del widget
"""

from flask import Blueprint, request, jsonify
from typing import Dict, Optional
import logging
from datetime import datetime
from pathlib import Path

# Importar el bot de ventas
from bots.bot_advertising_sales import (
    responder_consulta_ventas,
    AdvertisingSalesBot,
    ADVERTISING_PLANS
)

logger = logging.getLogger(__name__)

# Crear blueprint
advertising_api = Blueprint('advertising_api', __name__, url_prefix='/api/bot')

# ============================================================================
# ENDPOINTS
# ============================================================================

@advertising_api.route('/advertising', methods=['POST'])
def handle_advertising_query():
    """
    Endpoint principal para el widget Luna.

    POST /api/bot/advertising
    {
        "message": str,
        "language": "es" | "en",
        "conversation_id": str (opcional),
        "user_id": str (opcional)
    }

    Returns:
    {
        "type": str,
        "message": str,
        "quick_replies": [...],
        "plans": [...],
        "testimonials": [...]
    }
    """

    try:
        data = request.json

        if not data or 'message' not in data:
            return jsonify({
                "error": "Missing 'message' field"
            }), 400

        message = data.get('message', '').strip()
        language = data.get('language', 'es').lower()
        conversation_id = data.get('conversation_id')
        user_id = data.get('user_id')

        # Validar idioma
        if language not in ['es', 'en']:
            language = 'es'

        if not message:
            return jsonify({
                "error": "Empty message"
            }), 400

        # Obtener respuesta del bot
        response = responder_consulta_ventas(message, language)

        # Enriquecer respuesta con contexto
        response['conversation_id'] = conversation_id
        response['user_id'] = user_id
        response['timestamp'] = datetime.utcnow().isoformat()

        # Log
        log_conversation(
            message=message,
            language=language,
            response_type=response.get('type'),
            conversation_id=conversation_id,
            user_id=user_id
        )

        return jsonify(response), 200

    except Exception as e:
        logger.error(f"Error en advertising endpoint: {e}", exc_info=True)
        return jsonify({
            "error": "Internal server error",
            "message": str(e)
        }), 500


@advertising_api.route('/advertising/plans', methods=['GET'])
def get_plans():
    """
    GET /api/bot/advertising/plans?language=es

    Retorna todos los planes disponibles.
    """

    try:
        language = request.args.get('language', 'es').lower()

        if language not in ['es', 'en']:
            language = 'es'

        plans_data = ADVERTISING_PLANS.get(language, ADVERTISING_PLANS['es'])

        # Convertir a lista
        plans_list = []
        for plan_id, plan_info in plans_data.items():
            plan = plan_info.copy()
            plan['id'] = plan_id
            plans_list.append(plan)

        return jsonify({
            "language": language,
            "plans": plans_list,
            "count": len(plans_list)
        }), 200

    except Exception as e:
        logger.error(f"Error obteniendo planes: {e}")
        return jsonify({"error": str(e)}), 500


@advertising_api.route('/advertising/plans/<plan_id>', methods=['GET'])
def get_plan_detail(plan_id):
    """
    GET /api/bot/advertising/plans/{plan_id}?language=es

    Retorna detalles de un plan específico.
    """

    try:
        language = request.args.get('language', 'es').lower()

        if language not in ['es', 'en']:
            language = 'es'

        bot = AdvertisingSalesBot()
        response = bot.get_plan_details(plan_id, language)

        if 'error' in response:
            return jsonify(response), 404

        return jsonify(response), 200

    except Exception as e:
        logger.error(f"Error obteniendo detalle de plan: {e}")
        return jsonify({"error": str(e)}), 500


@advertising_api.route('/advertising/inquiry', methods=['POST'])
def create_inquiry():
    """
    POST /api/bot/advertising/inquiry
    {
        "name": str,
        "email": str,
        "business_name": str,
        "phone": str,
        "language": "es" | "en",
        "plan_interested": str (opcional),
        "message": str (opcional)
    }

    Captura información de un cliente interesado.
    """

    try:
        data = request.json

        required_fields = ['name', 'email', 'business_name', 'phone']
        for field in required_fields:
            if field not in data:
                return jsonify({
                    "error": f"Missing required field: {field}"
                }), 400

        language = data.get('language', 'es').lower()

        bot = AdvertisingSalesBot()
        result = bot.create_inquiry(
            name=data['name'],
            email=data['email'],
            business_name=data['business_name'],
            phone=data['phone'],
            language=language
        )

        if result['success']:
            return jsonify(result), 201
        else:
            return jsonify(result), 500

    except Exception as e:
        logger.error(f"Error creando inquiry: {e}")
        return jsonify({
            "error": "Internal server error",
            "message": str(e)
        }), 500


@advertising_api.route('/advertising/greeting', methods=['GET'])
def get_greeting():
    """
    GET /api/bot/advertising/greeting?language=es&time=morning

    Retorna un saludo dinámico.
    """

    try:
        language = request.args.get('language', 'es').lower()
        time_of_day = request.args.get('time', 'morning').lower()

        if language not in ['es', 'en']:
            language = 'es'

        if time_of_day not in ['morning', 'afternoon', 'evening']:
            time_of_day = 'morning'

        bot = AdvertisingSalesBot()
        response = bot.get_greeting(language, time_of_day)

        return jsonify(response), 200

    except Exception as e:
        logger.error(f"Error obteniendo saludo: {e}")
        return jsonify({"error": str(e)}), 500


@advertising_api.route('/advertising/testimonials', methods=['GET'])
def get_testimonials():
    """
    GET /api/bot/advertising/testimonials?language=es

    Retorna testimonios de clientes.
    """

    try:
        language = request.args.get('language', 'es').lower()

        if language not in ['es', 'en']:
            language = 'es'

        bot = AdvertisingSalesBot()
        response = bot.get_testimonials(language)

        return jsonify(response), 200

    except Exception as e:
        logger.error(f"Error obteniendo testimonios: {e}")
        return jsonify({"error": str(e)}), 500


@advertising_api.route('/advertising/health', methods=['GET'])
def health_check():
    """
    GET /api/bot/advertising/health

    Health check endpoint.
    """
    return jsonify({
        "status": "healthy",
        "bot": "advertising_sales",
        "timestamp": datetime.utcnow().isoformat()
    }), 200


# ============================================================================
# UTILITIES
# ============================================================================

def log_conversation(message: str, language: str, response_type: str,
                    conversation_id: Optional[str] = None,
                    user_id: Optional[str] = None):
    """
    Registra conversaciones en archivo de log.

    TODO: Integrar con analytics/database
    """

    log_entry = {
        "timestamp": datetime.utcnow().isoformat(),
        "message": message,
        "language": language,
        "response_type": response_type,
        "conversation_id": conversation_id,
        "user_id": user_id
    }

    try:
        logs_dir = Path(__file__).parent.parent / 'data' / 'logs'
        logs_dir.mkdir(parents=True, exist_ok=True)

        log_file = logs_dir / 'advertising_conversations.jsonl'

        with open(log_file, 'a', encoding='utf-8') as f:
            import json
            f.write(json.dumps(log_entry, ensure_ascii=False) + '\n')

    except Exception as e:
        logger.error(f"Error logging conversation: {e}")


# ============================================================================
# REGISTRO DEL BLUEPRINT
# ============================================================================

def register_advertising_api(app):
    """
    Registrar el blueprint en la aplicación Flask.

    Uso en main.py o app.py:

        from routes.advertising_api import register_advertising_api

        app = Flask(__name__)
        register_advertising_api(app)
    """
    app.register_blueprint(advertising_api)
    logger.info("Advertising API blueprint registrado")
