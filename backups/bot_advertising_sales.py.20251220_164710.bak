"""
Bot de Ventas de Espacios Publicitarios - BilingÃ¼e
Ayuda a comercios y empresas a anunciarse en la Revista de Expatriados
Ofrece planes flexibles y dinÃ¡micos conversacionales
"""

import json
from typing import List, Dict, Optional
from .logger import logger
from config import settings

# ============================================================================
# PLANES Y PRECIOS (Flexible - fÃ¡cil de ajustar)
# ============================================================================

ADVERTISING_PLANS = {
    "es": {
        "directorio_mensual": {
            "nombre": "Directorio - Mensual",
            "precio": "34â‚¬/mes",
            "precio_num": 34,
            "duracion": "1 mes",
            "beneficios": [
                "âœ… Listing en directorio digital",
                "âœ… Perfil completo con foto y descripciÃ³n",
                "âœ… CategorÃ­as sin lÃ­mite",
                "âœ… Visible para 12,000+ usuarios/mes",
                "âœ… Analytics de visitas y clics",
                "âœ… Soporte por email",
                "âœ… ActualizaciÃ³n ilimitada de perfil"
            ],
            "ideal_para": "Todos los negocios"
        },
        "directorio_anual": {
            "nombre": "Directorio - Anual (10% Descuento)",
            "precio": "367â‚¬/aÃ±o",
            "precio_num": 367.2,
            "precio_original": 408,
            "duracion": "12 meses",
            "beneficios": [
                "âœ… TODO lo del plan mensual",
                "âœ… 10% DESCUENTO (34â‚¬ x 12 = 408â‚¬ â†’ 367â‚¬/aÃ±o)",
                "âœ… Visibilidad garantizada todo el aÃ±o",
                "âœ… 1 sesiÃ³n de asesoramiento estratÃ©gico GRATIS",
                "âœ… Soporte prioritario",
                "âœ… Newsletter semanal exclusiva",
                "âœ… Acceso a eventos de la revista"
            ],
            "ahorro": "10%",
            "ideal_para": "Compromisos a largo plazo - Ahorro garantizado"
        },
        "campana_especial": {
            "nombre": "CampaÃ±as Especiales",
            "precio": "Personalizado",
            "precio_num": 0,
            "duracion": "Variable",
            "beneficios": [
                "âœ… Trato PREFERENTE con revista",
                "âœ… Precios especiales negociables",
                "âœ… AcompaÃ±amiento profesional de nuestro equipo",
                "âœ… Estrategia personalizada para impacto",
                "âœ… Visibilidad aumentada en el directorio",
                "âœ… Newsletter promocional dedicada",
                "âœ… Soporte VIP durante la campaÃ±a",
                "âœ… AnÃ¡lisis y reporte de resultados"
            ],
            "ideal_para": "Negocios que quieren crecer rÃ¡pido",
            "nota": "Disponible para clientes anuales"
        }
    },
    "en": {
        "directorio_mensual": {
            "nombre": "Directory - Monthly",
            "precio": "34â‚¬/month",
            "precio_num": 34,
            "duracion": "1 month",
            "beneficios": [
                "âœ… Digital directory listing",
                "âœ… Complete profile with photo and description",
                "âœ… Unlimited categories",
                "âœ… Visible to 12,000+ users/month",
                "âœ… Analytics of visits and clicks",
                "âœ… Email support",
                "âœ… Unlimited profile updates"
            ],
            "ideal_para": "All businesses"
        },
        "directorio_anual": {
            "nombre": "Directory - Annual (10% Discount)",
            "precio": "367â‚¬/year",
            "precio_num": 367.2,
            "precio_original": 408,
            "duracion": "12 months",
            "beneficios": [
                "âœ… EVERYTHING from monthly plan",
                "âœ… 10% DISCOUNT (34â‚¬ x 12 = 408â‚¬ â†’ 367â‚¬/year)",
                "âœ… Guaranteed visibility all year",
                "âœ… 1 FREE strategic consultation session",
                "âœ… Priority support",
                "âœ… Exclusive weekly newsletter",
                "âœ… Access to magazine events"
            ],
            "ahorro": "10%",
            "ideal_para": "Long-term commitments - Guaranteed savings"
        },
        "campana_especial": {
            "nombre": "Special Campaigns",
            "precio": "Custom",
            "precio_num": 0,
            "duracion": "Variable",
            "beneficios": [
                "âœ… PREFERRED treatment with magazine",
                "âœ… Special negotiable pricing",
                "âœ… Professional support from our team",
                "âœ… Personalized strategy for impact",
                "âœ… Increased visibility in directory",
                "âœ… Dedicated promotional newsletter",
                "âœ… VIP support during campaign",
                "âœ… Results analysis and report"
            ],
            "ideal_para": "Businesses wanting rapid growth",
            "nota": "Available for annual customers"
        }
    }
}

# ============================================================================
# MENSAJES PROACTIVOS (Burbujas de diÃ¡logo que se abren)
# ============================================================================

PROACTIVE_MESSAGES = {
    "es": {
        "greeting_morning": "Â¡Hola! ðŸ‘‹ Â¿Quieres que tu negocio aparezca en nuestro directorio? Solo 34â‚¬/mes.",
        "greeting_afternoon": "Â¡Hey! ðŸŒŸ Negocios como el tuyo ya estÃ¡n en nuestro directorio. Â¿Te unes?",
        "greeting_evening": "Â¡Buenas noches! ðŸŒ™ Aparece en nuestro directorio desde 34â‚¬/mes.",
        "business_pitch": "ðŸ’¼ Â¿Buscas aumentar visibilidad? Ãšnete a 280+ negocios en nuestro directorio.",
        "testimonial": "ðŸ˜Š Otros negocios han triplicado consultas con nosotros...",
        "campaign_offer": "ðŸš€ Â¿Quieres impulsar tu campaÃ±a? Ofrecemos acompaÃ±amiento profesional.",
        "annual_savings": "ðŸŽ Contratando por un aÃ±o: 10% descuento = 367â‚¬ en vez de 408â‚¬",
    },
    "en": {
        "greeting_morning": "Hello! ðŸ‘‹ Want your business in our directory? Just 34â‚¬/month.",
        "greeting_afternoon": "Hey! ðŸŒŸ Businesses like yours are already in our directory. Join us?",
        "greeting_evening": "Good evening! ðŸŒ™ Appear in our directory from 34â‚¬/month.",
        "business_pitch": "ðŸ’¼ Looking to increase visibility? Join 280+ businesses in our directory.",
        "testimonial": "ðŸ˜Š Other businesses have tripled consultations with us...",
        "campaign_offer": "ðŸš€ Want to boost your campaign? We offer professional support.",
        "annual_savings": "ðŸŽ Annual subscription: 10% discount = 367â‚¬ instead of 408â‚¬",
    }
}

# ============================================================================
# MASCOTA/AVATAR DESCRIPTION
# ============================================================================

MASCOT = {
    "name_es": "Luna",
    "name_en": "Luna",
    "description_es": "Un simpÃ¡tico bÃºho con grandes ojos curiosos ðŸ¦‰",
    "description_en": "A cute owl with big curious eyes ðŸ¦‰",
    "emoji": "ðŸ¦‰",
    "color": "#FF6B6B",  # Rojo coral cÃ¡lido
    "personality": "Amigable, curioso, motivador"
}

# ============================================================================
# FLUJO DE CONVERSACIÃ“N DE VENTA
# ============================================================================

class AdvertisingSalesBot:
    """
    Bot dinÃ¡mico para vender espacios publicitarios en la revista.

    Responsabilidades:
    - Presentar planes de forma atractiva
    - Responder preguntas sobre beneficios
    - Iniciar conversaciones proactivas
    - Capturar informaciÃ³n de interesados
    """

    def __init__(self):
        self.plans = ADVERTISING_PLANS
        self.messages = PROACTIVE_MESSAGES
        self.mascot = MASCOT
        logger.info("AdvertisingSalesBot inicializado")

    def get_greeting(self, language: str = "es", time_of_day: str = "morning") -> Dict:
        """
        Retorna un saludo dinÃ¡mico basado en la hora del dÃ­a.

        Args:
            language: "es" o "en"
            time_of_day: "morning", "afternoon", "evening"

        Returns:
            Dict con mensaje y opciones de respuesta
        """
        lang_messages = self.messages.get(language, self.messages["es"])
        key = f"greeting_{time_of_day}"
        message = lang_messages.get(key, lang_messages["greeting_morning"])

        return {
            "type": "greeting",
            "message": message,
            "mascot": {
                "emoji": self.mascot["emoji"],
                "name": self.mascot["name_es"] if language == "es" else self.mascot["name_en"],
            },
            "quick_replies": [
                {"text": "SÃ­, necesito ayuda" if language == "es" else "Yes, I need help", "action": "help"},
                {"text": "Soy un negocio" if language == "es" else "I'm a business", "action": "business"},
                {"text": "Solo navegando" if language == "es" else "Just browsing", "action": "browse"},
            ]
        }

    def get_plans_comparison(self, language: str = "es") -> Dict:
        """
        Retorna comparativa visual de planes.

        Muestra:
        - Tabla con planes lado a lado
        - Precios destacados
        - Botones de CTA
        """
        lang_plans = self.plans.get(language, self.plans["es"])

        plans_data = []
        for plan_key, plan_info in lang_plans.items():
            plans_data.append({
                "id": plan_key,
                "nombre": plan_info["nombre"],
                "precio": plan_info["precio"],
                "duracion": plan_info["duracion"],
                "beneficios": plan_info["beneficios"],
                "ideal_para": plan_info["ideal_para"],
                "cta_text": "Elegir este plan" if language == "es" else "Choose this plan"
            })

        return {
            "type": "plans_comparison",
            "title": "Nuestros Planes" if language == "es" else "Our Plans",
            "subtitle": "Elige el perfecto para tu negocio" if language == "es" else "Choose the perfect one for your business",
            "plans": plans_data,
            "note": "Todos incluyen soporte 24/7 y garantÃ­a de satisfacciÃ³n" if language == "es" else "All include 24/7 support and satisfaction guarantee"
        }

    def get_plan_details(self, plan_id: str, language: str = "es") -> Dict:
        """
        Retorna detalles detallados de un plan especÃ­fico.
        """
        lang_plans = self.plans.get(language, self.plans["es"])

        if plan_id not in lang_plans:
            logger.warning(f"Plan no encontrado: {plan_id}")
            return {"error": f"Plan '{plan_id}' not found"}

        plan = lang_plans[plan_id]

        return {
            "type": "plan_details",
            "plan_id": plan_id,
            "nombre": plan["nombre"],
            "precio": plan["precio"],
            "duracion": plan["duracion"],
            "beneficios": plan["beneficios"],
            "ideal_para": plan["ideal_para"],
            "cta_primary": {
                "text": "Contratar ahora" if language == "es" else "Get started now",
                "action": f"contract_plan:{plan_id}"
            },
            "cta_secondary": {
                "text": "MÃ¡s informaciÃ³n" if language == "es" else "Learn more",
                "action": "contact_sales"
            }
        }

    def respond_to_question(self, question: str, language: str = "es") -> Dict:
        """
        Responde preguntas frecuentes sobre planes y beneficios.

        Usa bÃºsqueda simple de keywords para matchear preguntas.
        """
        question_lower = question.lower()

        # FAQ Map por idioma
        faq_map = {
            "es": {
                "precio|costo|cuanto": "Nuestros precios varÃ­an desde 19â‚¬/mes (Plan BÃ¡sico) hasta 199â‚¬/aÃ±o (Directorio Anual). Todos incluyen garantÃ­a de satisfacciÃ³n.",
                "beneficio|incluye": "Cada plan incluye listado digital, analytics, y visibilidad entre nuestros usuarios. Los planes premium aÃ±aden featured status y mÃ¡s categorÃ­as.",
                "cancelar|devolucion|dinero": "Puedes cancelar en cualquier momento. Si no estÃ¡s satisfecho en los primeros 30 dÃ­as, devolvemos el 100% de tu dinero.",
                "como funciona|como se": "1ï¸âƒ£ Elige tu plan 2ï¸âƒ£ Crea tu perfil 3ï¸âƒ£ Aparece en el directorio 4ï¸âƒ£ Los usuarios te encuentran!",
                "categoria|servicio": "Puedes elegir hasta 5-10 categorÃ­as dependiendo de tu plan (Abogado, MÃ©dico, Restaurante, Escuela, Alojamiento, etc.).",
                "soporte|ayuda": "Â¡Claro! Tenemos soporte 24/7 en espaÃ±ol e inglÃ©s. Whatsapp, email o telÃ©fono.",
                "analytic|estadisticas": "Todos nuestros planes incluyen analytics. Ve cuÃ¡ntos usuarios te encuentran, cuÃ¡ntos clics recibes, y mÃ¡s.",
            },
            "en": {
                "price|cost|much": "Our prices range from 19â‚¬/month (Basic Plan) to 199â‚¬/year (Annual Directory). All include satisfaction guarantee.",
                "benefit|include": "Each plan includes digital listing, analytics, and visibility among our users. Premium plans add featured status and more categories.",
                "cancel|refund|money": "You can cancel anytime. If unsatisfied within 30 days, we return 100% of your money.",
                "how|work": "1ï¸âƒ£ Choose your plan 2ï¸âƒ£ Create your profile 3ï¸âƒ£ Appear in directory 4ï¸âƒ£ Users find you!",
                "category|service": "You can choose up to 5-10 categories depending on your plan (Lawyer, Doctor, Restaurant, School, Accommodation, etc.).",
                "support|help": "Sure! We have 24/7 support in Spanish & English. Whatsapp, email, or phone.",
                "analytic|statistic": "All our plans include analytics. See how many users find you, how many clicks you get, and more.",
            }
        }

        lang_faq = faq_map.get(language, faq_map["es"])

        # Busca match en keywords
        for keywords, answer in lang_faq.items():
            keyword_list = keywords.split("|")
            if any(kw in question_lower for kw in keyword_list):
                return {
                    "type": "faq_answer",
                    "question": question,
                    "answer": answer,
                    "follow_up": {
                        "text": "Â¿Quieres contratar?" if language == "es" else "Want to get started?",
                        "action": "show_plans"
                    }
                }

        # Si no hay match, respuesta genÃ©rica
        return {
            "type": "generic_response",
            "answer": "Excelente pregunta. Contacta con nuestro equipo de ventas para mÃ¡s detalles." if language == "es" else "Great question. Contact our sales team for more details.",
            "follow_up": {
                "text": "Hablar con ventas" if language == "es" else "Talk to sales",
                "action": "contact_sales"
            }
        }

    def get_testimonials(self, language: str = "es") -> Dict:
        """
        Retorna testimonios de negocios exitosos.
        """
        testimonials = {
            "es": [
                {
                    "nombre": "Juan LÃ³pez",
                    "negocio": "Abogado - Especialista en NIE",
                    "plan": "Plan Premium",
                    "testimonial": "En 3 meses triplicamos nuestras consultas. Recomendado 100%.",
                    "emoji": "â­â­â­â­â­"
                },
                {
                    "nombre": "Marta GarcÃ­a",
                    "negocio": "ClÃ­nica Dental",
                    "plan": "Plan Featured",
                    "testimonial": "Los analytics nos muestran exactamente dÃ³nde vienen nuestros pacientes. IncreÃ­ble ROI.",
                    "emoji": "â­â­â­â­â­"
                },
                {
                    "nombre": "Carlos MÃ¼ller",
                    "negocio": "Academia de Idiomas",
                    "plan": "Plan Anual",
                    "testimonial": "30% de ahorro con el plan anual y 40% mÃ¡s estudiantes. La mejor inversiÃ³n.",
                    "emoji": "â­â­â­â­â­"
                }
            ],
            "en": [
                {
                    "nombre": "John Smith",
                    "negocio": "Lawyer - NIE Specialist",
                    "plan": "Premium Plan",
                    "testimonial": "Tripled our consultations in 3 months. Highly recommended.",
                    "emoji": "â­â­â­â­â­"
                },
                {
                    "nombre": "Sarah Miller",
                    "negocio": "Dental Clinic",
                    "plan": "Featured Plan",
                    "testimonial": "Analytics show us exactly where our patients come from. Incredible ROI.",
                    "emoji": "â­â­â­â­â­"
                },
                {
                    "nombre": "Miguel PÃ©rez",
                    "negocio": "Language Academy",
                    "plan": "Annual Plan",
                    "testimonial": "30% savings with annual plan and 40% more students. Best investment ever.",
                    "emoji": "â­â­â­â­â­"
                }
            ]
        }

        lang_testimonials = testimonials.get(language, testimonials["es"])

        return {
            "type": "testimonials",
            "title": "Lo que dicen nuestros clientes" if language == "es" else "What our clients say",
            "testimonials": lang_testimonials
        }

    def create_inquiry(self, name: str, email: str, business_name: str,
                      phone: str, language: str = "es") -> Dict:
        """
        Captura informaciÃ³n de un cliente interesado.

        Guarda en data/inquiries/ para seguimiento.
        """
        from pathlib import Path
        import datetime

        inquiry_data = {
            "timestamp": datetime.datetime.utcnow().isoformat(),
            "name": name,
            "email": email,
            "business_name": business_name,
            "phone": phone,
            "language": language,
            "status": "new"
        }

        # Guardar inquiry
        try:
            inquiries_dir = Path(settings.DATA_DIR) / "inquiries"
            inquiries_dir.mkdir(parents=True, exist_ok=True)

            filename = f"inquiry_{inquiry_data['timestamp'].replace(':', '-')}.json"
            filepath = inquiries_dir / filename

            with open(filepath, 'w', encoding='utf-8') as f:
                json.dump(inquiry_data, f, ensure_ascii=False, indent=2)

            logger.info(f"Inquiry guardado: {business_name} ({email})")

            return {
                "success": True,
                "message": "Â¡Gracias! Nos pondremos en contacto en 24 horas." if language == "es" else "Thank you! We'll contact you within 24 hours.",
                "inquiry_id": filename
            }

        except Exception as e:
            logger.error(f"Error guardando inquiry: {e}")
            return {
                "success": False,
                "message": "Error al procesar tu solicitud. Intenta de nuevo.",
                "error": str(e)
            }


# ============================================================================
# ENDPOINT PRINCIPAL
# ============================================================================

def responder_consulta_ventas(pregunta: str, language: str = "es") -> Dict:
    """
    Punto de entrada principal para el bot de ventas.

    Detects intenciÃ³n y enruta a la funciÃ³n correcta.
    """
    bot = AdvertisingSalesBot()
    pregunta_lower = pregunta.lower()

    # DetecciÃ³n de intenciÃ³n
    if any(word in pregunta_lower for word in ["plan", "precio", "costo", "incluye"]):
        return bot.get_plans_comparison(language)

    elif any(word in pregunta_lower for word in ["anunciar", "advertise", "publicidad", "advertising"]):
        return {
            "type": "advertising_intro",
            "message": "Â¡Excelente! Los negocios como el tuyo crecen con nosotros. ðŸ“ˆ" if language == "es" else "Excellent! Businesses like yours grow with us. ðŸ“ˆ",
            "next": bot.get_plans_comparison(language)
        }

    elif any(word in pregunta_lower for word in ["testimonial", "client", "cliente", "review"]):
        return bot.get_testimonials(language)

    else:
        # Pregunta abierta - responder con FAQ
        return bot.respond_to_question(pregunta, language)
