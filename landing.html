<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Revista Expats - Tu Gu√≠a para Vivir en Espa√±a</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: system-ui, Segoe UI, Helvetica, Arial; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }

    .hero { color: white; text-align: center; padding: 60px 20px; }
    .hero h1 { font-size: 3em; margin-bottom: 10px; }
    .hero p { font-size: 1.2em; margin-bottom: 40px; opacity: 0.9; }

    .paths { display: flex; gap: 20px; max-width: 1000px; margin: 0 auto 40px; flex-wrap: wrap; justify-content: center; }
    .path-card {
      background: white;
      padding: 30px;
      border-radius: 10px;
      cursor: pointer;
      transition: transform 0.3s, box-shadow 0.3s;
      flex: 1;
      min-width: 250px;
      text-align: center;
    }
    .path-card:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
    .path-card h2 { color: #667eea; margin-bottom: 15px; }
    .path-card p { color: #666; margin-bottom: 20px; }
    .path-card button {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1em;
    }
    .path-card button:hover { background: #764ba2; }

    .content {
      background: white;
      margin: 20px auto;
      padding: 30px;
      max-width: 900px;
      border-radius: 10px;
      display: none;
    }
    .content.active { display: block; }

    label, input, select, button { display: block; margin: 8px 0; }
    #result { white-space: pre-wrap; border: 1px solid #ddd; padding: 12px; margin-top: 12px; }
    .gallery { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 12px; }
    .card { width: 200px; border: 1px solid #eee; padding: 8px; border-radius: 6px; text-align: center; background: #f9f9f9; }
    .card img { max-width: 100%; height: 150px; object-fit: cover; border-radius: 4px; cursor: pointer; }
    .card small { display: block; margin-top: 6px; color: #666; }

    .back-btn { background: #666; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin-bottom: 20px; }
    .back-btn:hover { background: #333; }
  </style>
</head>
<body>
  <!-- HERO CON DOS CAMINOS -->
  <div class="hero">
    <h1>üåç Tu Gu√≠a Completa para Vivir en Espa√±a</h1>
    <p>Informaci√≥n para extranjeros que buscan mudarse y para expats que ya viven aqu√≠</p>

    <div class="paths">
      <div class="path-card">
        <h2>‚úàÔ∏è Voy a Mudarme</h2>
        <p>Soy extranjero y estoy pensando vivir en Espa√±a. Necesito informaci√≥n sobre visados, NIE y primeros pasos.</p>
        <button onclick="selectPath('immigrant')">Comenzar</button>
      </div>

      <div class="path-card">
        <h2>üèòÔ∏è Ya Vivo en Espa√±a</h2>
        <p>Soy expatriado en Madrid, Barcelona, Valencia o cualquier ciudad. Busco servicios, recomendaciones e informaci√≥n √∫til para mi d√≠a a d√≠a.</p>
        <button onclick="selectPath('expat')">Comenzar</button>
      </div>
    </div>
  </div>

  <!-- CONTENIDO DIN√ÅMICO -->
  <div class="content" id="immigrant-content">
    <button class="back-btn" onclick="selectPath(null)">‚Üê Volver</button>
    <h1>‚úàÔ∏è Informaci√≥n para Inmigraci√≥n</h1>
    <p>Asistente especializado en visados, documentaci√≥n y primeros pasos para vivir en Espa√±a.</p>

    <label for="pregunta-immigrant">Tu pregunta</label>
    <input id="pregunta-immigrant" type="text" placeholder="ej. ¬øQu√© necesito para vivir en Espa√±a? O dame info sobre Argentina" style="width:100%" />

    <label for="language-immigrant">Idioma</label>
    <select id="language-immigrant">
      <option value="es">Espa√±ol</option>
      <option value="en">English</option>
    </select>

    <button onclick="consultarImmigration()">Consultar</button>
    <div id="status-immigrant" style="margin-top:8px;color:#444"></div>
    <div id="result-immigrant" style="margin-top:12px"></div>
  </div>

  <!-- CONTENIDO EXPAT -->
  <div class="content" id="expat-content">
    <button class="back-btn" onclick="selectPath(null)">‚Üê Volver</button>
    <h1>üèòÔ∏è Servicios para Expatriados en Espa√±a</h1>
    <p>Encuentra servicios, recomendaciones y toda la informaci√≥n que necesitas para vivir c√≥modamente en cualquier ciudad de Espa√±a (Madrid, Barcelona, Valencia, M√°laga, Bilbao, etc.).</p>

    <label for="pregunta-expat">¬øQu√© servicio buscas en Espa√±a?</label>
    <input id="pregunta-expat" type="text" placeholder="ej. un dentista en Madrid, un abogado, d√≥nde aprender espa√±ol, busco escuela para mi hijo..." style="width:100%" />

    <label for="language-expat">Idioma</label>
    <select id="language-expat">
      <option value="es">Espa√±ol</option>
      <option value="en">English</option>
    </select>

    <button onclick="consultarExpat()">Consultar</button>
    <label><input type="checkbox" id="autoSend" /> Auto-enviar al seleccionar imagen</label>

    <div id="status-expat" style="margin-top:8px;color:#444"></div>
    <div id="result-expat" style="margin-top:12px"></div>
    <div id="parsed" style="margin-top:12px"></div>

    <h2>Categor√≠as de Servicios</h2>
    <div class="gallery" id="gallery">
      <div class="card"><img src="landi/1.png" alt="W Hotel" data-name="W Hotel" data-category="Accommodation" /><small>W Hotel</small></div>
      <div class="card"><img src="landi/2.png" alt="Enjoy Apartments Barcelona" data-name="Enjoy Apartments Barcelona" data-category="Accommodation" /><small>Enjoy Apartments</small></div>
      <div class="card"><img src="landi/3.png" alt="Hotel Novotel" data-name="Hotel Novotel Barcelona City" data-category="Accommodation" /><small>Hotel Novotel</small></div>
      <div class="card"><img src="landi/4.png" alt="Restaurante Ejemplo" data-name="Restaurante Ejemplo" data-category="Restaurants" /><small>Restaurante</small></div>
      <div class="card"><img src="landi/5.png" alt="Consultoria Legal" data-name="Consultoria Legal" data-category="Legal and Financial" /><small>Legal</small></div>
      <div class="card"><img src="landi/6.png" alt="Centro Salud" data-name="Centro Salud" data-category="Healthcare" /><small>Healthcare</small></div>
      <div class="card"><img src="landi/7.png" alt="Tienda Local" data-name="Tienda Local" data-category="Retail" /><small>Retail</small></div>
    </div>
  </div>

  <script>
    const apiBase = (window.location.protocol === 'file:' || window.location.origin === 'null')
      ? 'http://127.0.0.1:8000'
      : window.location.origin;

    function selectPath(path) {
      const immigrantContent = document.getElementById('immigrant-content');
      const expatContent = document.getElementById('expat-content');

      if (path === 'immigrant') {
        immigrantContent.classList.add('active');
        expatContent.classList.remove('active');
      } else if (path === 'expat') {
        expatContent.classList.add('active');
        immigrantContent.classList.remove('active');
      } else {
        immigrantContent.classList.remove('active');
        expatContent.classList.remove('active');
      }
    }

    async function consultarImmigration() {
      const pregunta = document.getElementById('pregunta-immigrant').value.trim();
      const language = document.getElementById('language-immigrant').value;
      const statusDiv = document.getElementById('status-immigrant');
      const resultDiv = document.getElementById('result-immigrant');

      if (!pregunta) {
        statusDiv.textContent = 'Escribe una pregunta antes de consultar.';
        return;
      }

      statusDiv.textContent = 'Enviando petici√≥n‚Ä¶';
      resultDiv.innerHTML = '';

      try {
        const res = await fetch(`${apiBase}/api/immigration`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: pregunta, language })
        });

        const data = await res.json();

        // Mostrar respuesta principal
        const messageDiv = document.createElement('div');
        messageDiv.style.cssText = 'background: #f0f0f0; padding: 15px; border-radius: 5px; margin-bottom: 15px; white-space: pre-wrap;';
        messageDiv.textContent = data.message || data.respuesta || 'Sin respuesta';
        resultDiv.appendChild(messageDiv);

        // Mostrar firmas legales anunciantes si existen
        if (data.legal_ads && data.legal_ads.length > 0) {
          const adsTitle = document.createElement('h3');
          adsTitle.textContent = language === 'es' ? 'üìã Firmas Anunciantes en la Revista' : 'üìã Advertiser Law Firms';
          adsTitle.style.cssText = 'margin-top: 20px; color: #667eea;';
          resultDiv.appendChild(adsTitle);

          const adsContainer = document.createElement('div');
          adsContainer.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; margin-top: 10px;';

          data.legal_ads.forEach(ad => {
            const adCard = document.createElement('div');
            adCard.style.cssText = 'border: 2px solid #667eea; padding: 15px; border-radius: 8px; background: #f9f9ff;';
            adCard.innerHTML = `
              <strong style="color: #667eea; font-size: 1.1em;">${ad.nombre || 'Firma Legal'}</strong><br/>
              <small style="color: #666;">${ad.descripcion || ''}</small><br/>
              <div style="margin-top: 8px;">
                ${ad.contacto ? `üìû <strong>${ad.contacto}</strong><br/>` : ''}
                ${ad.precio ? `üí∞ ${ad.precio}<br/>` : ''}
                ${ad.idiomas ? `üó£Ô∏è ${ad.idiomas}<br/>` : ''}
                ${ad.ubicacion ? `üìç ${ad.ubicacion}` : ''}
              </div>
              ${ad.beneficios && ad.beneficios.length ? `
                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd;">
                  <strong>Beneficios:</strong>
                  <ul style="margin: 5px 0; padding-left: 20px;">
                    ${ad.beneficios.map(b => `<li>${b}</li>`).join('')}
                  </ul>
                </div>
              ` : ''}
            `;
            adsContainer.appendChild(adCard);
          });

          resultDiv.appendChild(adsContainer);
        }

        statusDiv.textContent = 'Respuesta recibida.';
      } catch (err) {
        statusDiv.textContent = 'Error: ' + err.message;
        resultDiv.innerHTML = '<div style="color: #c00; padding: 10px;">No se pudo conectar con el servidor. Aseg√∫rate de que el servidor est√© corriendo en http://127.0.0.1:8000</div>';
      }
    }

    async function consultarExpat() {
      const pregunta = document.getElementById('pregunta-expat').value.trim();
      const language = document.getElementById('language-expat').value;
      const statusDiv = document.getElementById('status-expat');
      const resultDiv = document.getElementById('result-expat');

      if (!pregunta) {
        statusDiv.textContent = 'Escribe una pregunta antes de consultar.';
        return;
      }

      statusDiv.textContent = 'Enviando petici√≥n‚Ä¶';
      resultDiv.textContent = '';

      try {
        const res = await fetch(`${apiBase}/api/query`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ question: pregunta, language })
        });

        const data = await res.json();
        resultDiv.innerHTML = `<strong>Respuesta:</strong> ${data.respuesta || 'Sin respuesta'}<br/>
          ${data.json && data.json.length ? '<strong>Resultados:</strong>' : ''}`;

        if (data.json && data.json.length) {
          const list = document.createElement('div');
          list.style.display = 'grid';
          list.style.gridTemplateColumns = 'repeat(auto-fit,minmax(240px,1fr))';
          list.style.gap = '12px';
          list.style.marginTop = '12px';
          data.json.forEach(opt => {
            const card = document.createElement('div');
            card.style.border = '1px solid #ddd';
            card.style.padding = '12px';
            card.style.borderRadius = '6px';
            card.style.background = '#fafafa';
            card.innerHTML = `<strong>${opt.nombre}</strong><br/><small>${opt.descripcion || ''}</small><br/>üìû ${opt.contacto || 'N/A'}`;
            list.appendChild(card);
          });
          document.getElementById('parsed').appendChild(list);
        }
        statusDiv.textContent = 'Respuesta recibida.';
      } catch (err) {
        statusDiv.textContent = 'Error: ' + err.message;
        resultDiv.textContent = '';
      }
    }

    // Galer√≠a: al clicar imagen se rellena la pregunta
    document.getElementById('gallery').addEventListener('click', (ev) => {
      const img = ev.target.closest('img');
      if (!img) return;
      const name = img.dataset.name || img.alt || '';
      const category = img.dataset.category || '';
      document.getElementById('pregunta-expat').value = `Busco informaci√≥n sobre ${name}`;
      if (document.getElementById('autoSend').checked) consultarExpat();
    });

    // A√±adir manejadores de error para detectar recursos que fallen (im√°genes, scripts, hojas)
    function reportResourceFailure(msg) {
      const prev = document.getElementById('resourceErrors');
      if (!prev) {
        const el = document.createElement('div');
        el.id = 'resourceErrors';
        el.style.marginTop = '12px';
        el.style.color = '#b00';
        el.innerHTML = '<strong>Errores de recursos detectados:</strong><br/>' + msg;
        statusDiv.parentNode.insertBefore(el, resultDiv);
      } else {
        prev.innerHTML += '<br/>' + msg;
      }
      console.warn('Resource failure:', msg);
    }

    // Capturar errores globales (incluye recursos como im√°genes/hojas/scripts)
    window.addEventListener('error', function (ev) {
      try {
        if (ev.target && (ev.target.tagName === 'IMG' || ev.target.tagName === 'LINK' || ev.target.tagName === 'SCRIPT')) {
          const src = ev.target.src || ev.target.href || ev.filename || '<unknown>';
          reportResourceFailure(`Fallo carga recurso: ${src}`);
        } else {
          // errores JS normales
          reportResourceFailure(`Error JS: ${ev.message} (${ev.filename || ''}:${ev.lineno || ''})`);
        }
      } catch (e) { console.error(e); }
    }, true);

    // Capturar rejection de fetch no manejados
    window.addEventListener('unhandledrejection', function (ev) {
      reportResourceFailure(`Unhandled promise rejection: ${ev.reason && ev.reason.message ? ev.reason.message : JSON.stringify(ev.reason)}`);
    });

    // A√±adir onerror a todas las im√°genes para detectar fallos concretos
    document.querySelectorAll('img').forEach(img => {
      img.addEventListener('error', (e) => {
        const src = e.target && (e.target.currentSrc || e.target.src) || '<unknown>';
        reportResourceFailure(`Image load error: ${src}`);
      });
    });
  </script>

  <!-- ============================================================ -->
  <!-- LUNA ADVERTISING WIDGET -->
  <!-- ============================================================ -->
  <link rel="stylesheet" href="widget/luna-advertising.css">
  <script src="widget/luna-advertising.js"></script>
  <script>
    // Inicializar Luna Bot Widget
    document.addEventListener('DOMContentLoaded', function() {
      const lunaWidget = new LunaAdvertisingWidget({
        position: 'bottom-right',
        language: 'es', // 'es' o 'en'
        autoOpen: true,
        autoOpenDelay: 4000, // 4 segundos despu√©s de cargar
        apiEndpoint: 'http://127.0.0.1:8000/api/bot/advertising',
        theme: 'default' // 'default' o 'dark'
      });

      console.log('ü¶â Luna Widget activado en landing page');
    });
  </script>
</body>
</html>
