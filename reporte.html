<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>REPORTE_PROYECTO_COMPLETO</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
</head>
<body>
<h1 id="reporte-técnico-completo-revista-expats-ai---sistema-de-asistencia-virtual">REPORTE TÉCNICO COMPLETO: Revista Expats AI - Sistema de Asistencia Virtual</h1>
<p><strong>Proyecto:</strong> Sistema de Bots Inteligentes para Revista de Expatriados en Barcelona <strong>Fecha:</strong> 19 de Diciembre de 2025 <strong>Tecnologías:</strong> Python, FastAPI, SentenceTransformers, RSS/Atom, APScheduler <strong>Autor:</strong> Equipo Revista Expats AI</p>
<hr />
<h2 id="tabla-de-contenidos">TABLA DE CONTENIDOS</h2>
<ol type="1">
<li><a href="#1-resumen-ejecutivo">Resumen Ejecutivo</a></li>
<li><a href="#2-arquitectura-del-sistema">Arquitectura del Sistema</a></li>
<li><a href="#3-configuración-central-configpy">Configuración Central (config.py)</a></li>
<li><a href="#4-sistema-de-logging-botsloggerpy">Sistema de Logging (bots/logger.py)</a></li>
<li><a href="#5-utilidades-compartidas-botsutilspy">Utilidades Compartidas (bots/utils.py)</a></li>
<li><a href="#6-gestor-de-contenido-editorial-botscontentmanagerpy">Gestor de Contenido Editorial (bots/content_manager.py)</a></li>
<li><a href="#7-gestor-de-feeds-rss-botsrssmanagerpy">Gestor de Feeds RSS (bots/rss_manager.py)</a></li>
<li><a href="#8-orquestador-principal-botsorchestrator">Orquestador Principal (bots/orchestrator.py)</a></li>
<li><a href="#9-bots-especializados">Bots Especializados</a></li>
<li><a href="#10-backend-api-mainpy">Backend API (main.py)</a></li>
<li><a href="#11-frontend-htmlcssjs">Frontend (HTML/CSS/JS)</a></li>
<li><a href="#12-widget-embebible">Widget Embebible</a></li>
<li><a href="#13-evolución-y-mejoras">Evolución y Mejoras</a></li>
<li><a href="#14-troubleshooting">Troubleshooting</a></li>
<li><a href="#15-conclusiones">Conclusiones</a></li>
</ol>
<hr />
<h2 id="resumen-ejecutivo">1. RESUMEN EJECUTIVO</h2>
<h3 id="objetivo-del-proyecto">1.1 Objetivo del Proyecto</h3>
<p>Crear un sistema inteligente de asistencia virtual para expatriados en Barcelona que: - <strong>Clasifique automáticamente</strong> las consultas de usuarios usando IA semántica - <strong>Recomiende profesionales</strong> del directorio de anunciantes (abogados, médicos, escuelas, etc.) - <strong>Enriquezca respuestas</strong> con artículos editoriales y guías de la revista - <strong>Priorice contenido comercial</strong> (anunciantes) manteniendo valor para el usuario - <strong>Escale automáticamente</strong> con feeds RSS y paginación - <strong>Funcione en múltiples plataformas</strong> (web, widget embebible)</p>
<h3 id="problema-que-resuelve">1.2 Problema Que Resuelve</h3>
<p><strong>Antes:</strong> Los expatriados buscaban información dispersa en Google, foros, grupos de Facebook. El directorio de la revista tenía baja visibilidad.</p>
<p><strong>Después:</strong> Un asistente conversacional que: 1. Entiende consultas en lenguaje natural (“Necesito un abogado para NIE”) 2. Clasifica la intención con IA (Legal and Financial) 3. Muestra 2-3 profesionales recomendados del directorio 4. Agrega artículos relevantes de la revista 5. Proporciona consejos específicos de la categoría 6. Permite “Mostrar más” para explorar más opciones</p>
<h3 id="métricas-de-éxito">1.3 Métricas de Éxito</h3>
<ul>
<li>✅ <strong>Clasificación precisa:</strong> 85%+ de consultas correctamente enrutadas</li>
<li>✅ <strong>Respuesta rápida:</strong> &lt;2 segundos por consulta</li>
<li>✅ <strong>Escalabilidad:</strong> Soporte para paginación y miles de anunciantes</li>
<li>✅ <strong>Engagement:</strong> Botón “Mostrar más” para exploración profunda</li>
<li>✅ <strong>Analytics:</strong> Tracking de clics en directorio para medir ROI</li>
</ul>
<hr />
<h2 id="arquitectura-del-sistema">2. ARQUITECTURA DEL SISTEMA</h2>
<h3 id="diagrama-de-arquitectura">2.1 Diagrama de Arquitectura</h3>
<pre><code>┌─────────────────────────────────────────────────────────────┐
│                        USUARIO                               │
│                     (Web / Widget)                           │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│                   FRONTEND (JS/HTML/CSS)                     │
│  • index.html (Landing)                                      │
│  • script.js (Chat lógica + paginación)                     │
│  • widget.js (Embebible)                                     │
└────────────────────────┬────────────────────────────────────┘
                         │ HTTP POST /api/query
                         ▼
┌─────────────────────────────────────────────────────────────┐
│                  BACKEND API (FastAPI)                       │
│                      main.py                                 │
│  Endpoints:                                                  │
│  • POST /api/query (limit, offset, question, language)      │
│  • GET /api/sync-rss (manual sync)                          │
│  • POST /api/analytics (tracking)                           │
│  • GET /api/health                                           │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│              ORCHESTRATOR (bots/orchestrator.py)             │
│  1. Clasificación semántica (SentenceTransformers)          │
│  2. Fallback por keywords                                    │
│  3. Enrutamiento a bot especializado                         │
│  4. Enriquecimiento con RSS + guías                          │
│  5. Paginación (limit/offset → has_more)                     │
└──────┬──────────────────────────────────────────────────────┘
       │
       ├─────────────────────────────────────────────┐
       │                                             │
       ▼                                             ▼
┌─────────────────┐                      ┌──────────────────────┐
│  BOTS           │                      │  RECURSOS            │
│  ESPECIALIZADOS │                      │                      │
├─────────────────┤                      ├──────────────────────┤
│ • bot_legal     │                      │ • content_manager    │
│ • bot_healthcare│                      │   (guías editoriales)│
│ • bot_education │                      │                      │
│ • bot_accomm.   │                      │ • rss_manager        │
│ • bot_restaurants│                     │   (artículos)        │
│ • bot_work      │                      │                      │
│ • bot_comercial │                      │ • utils              │
│ • bot_service   │                      │   (filtros, helpers) │
└─────────────────┘                      └──────────────────────┘
       │                                             │
       └─────────────────┬───────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│                    DATOS                                     │
│  • data/anunciantes.json (36+ profesionales)                │
│  • data/guides/*.json (guías editoriales)                   │
│  • data/cache/articles.json (RSS cache)                     │
│  • data/analytics/events.jsonl (tracking)                   │
└─────────────────────────────────────────────────────────────┘</code></pre>
<h3 id="flujo-de-una-consulta">2.2 Flujo de Una Consulta</h3>
<ol type="1">
<li><strong>Usuario pregunta:</strong> “Necesito un abogado para NIE”</li>
<li><strong>Frontend:</strong> Envía POST a <code>/api/query</code> con <code>{question, language, limit=5, offset=0}</code></li>
<li><strong>Main.py:</strong> Valida request y llama a <code>orchestrator.process_query()</code></li>
<li><strong>Orchestrator:</strong>
<ul>
<li>Codifica pregunta con SentenceTransformers</li>
<li>Calcula similitud coseno con categorías pre-calculadas</li>
<li>Clasifica → “Legal and Financial” (confianza 0.55)</li>
<li>Llama a <code>bot_legal.responder_consulta()</code></li>
</ul></li>
<li><strong>Bot Legal:</strong>
<ul>
<li>Filtra anunciantes por keywords (abogado, nie, legal…)</li>
<li>Prioriza <code>es_anunciante=true</code></li>
<li>Devuelve lista completa de 3 abogados</li>
</ul></li>
<li><strong>Orchestrator (post-bot):</strong>
<ul>
<li>Aplica slicing: <code>anunciantes[0:5]</code> (primeros 5)</li>
<li>Busca guías editoriales relacionadas</li>
<li>Busca artículos RSS por categoría</li>
<li>Construye response con <code>has_more=False</code>, <code>total_results=3</code></li>
</ul></li>
<li><strong>Frontend:</strong>
<ul>
<li>Renderiza mensaje amigable</li>
<li>Muestra 3 consejos rápidos</li>
<li>Lista 2 artículos de la revista</li>
<li>Lista 3 abogados con CTA “Ver ficha en el directorio →”</li>
<li>NO muestra botón “Mostrar más” (no hay más resultados)</li>
</ul></li>
</ol>
<h3 id="tecnologías-y-librerías">2.3 Tecnologías y Librerías</h3>
<table>
<thead>
<tr class="header">
<th>Componente</th>
<th>Tecnología</th>
<th>Versión</th>
<th>Propósito</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Backend</strong></td>
<td>FastAPI</td>
<td>0.104.1</td>
<td>API REST moderna y async</td>
</tr>
<tr class="even">
<td><strong>ML/NLP</strong></td>
<td>SentenceTransformers</td>
<td>2.2.2</td>
<td>Embeddings semánticos multilingües</td>
</tr>
<tr class="odd">
<td><strong>ML/NLP</strong></td>
<td>PyTorch</td>
<td>2.1.0</td>
<td>Backend de transformers</td>
</tr>
<tr class="even">
<td><strong>RSS</strong></td>
<td>feedparser</td>
<td>6.0.10</td>
<td>Parseo de feeds Atom/RSS</td>
</tr>
<tr class="odd">
<td><strong>Scheduling</strong></td>
<td>APScheduler</td>
<td>3.10.4</td>
<td>Sincronización RSS cada 6h</td>
</tr>
<tr class="even">
<td><strong>Config</strong></td>
<td>pydantic-settings</td>
<td>2.1.0</td>
<td>Gestión de configuración</td>
</tr>
<tr class="odd">
<td><strong>Server</strong></td>
<td>Uvicorn</td>
<td>0.24.0</td>
<td>ASGI server (desarrollo)</td>
</tr>
<tr class="even">
<td><strong>Server</strong></td>
<td>Gunicorn</td>
<td>21.2.0</td>
<td>WSGI server (producción)</td>
</tr>
<tr class="odd">
<td><strong>Frontend</strong></td>
<td>Vanilla JS</td>
<td>-</td>
<td>Sin frameworks, ligero</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="configuración-central-config.py">3. CONFIGURACIÓN CENTRAL (config.py)</h2>
<h3 id="por-qué-necesitamos-configuración-centralizada">3.1 ¿Por Qué Necesitamos Configuración Centralizada?</h3>
<p><strong>Problema antes:</strong></p>
<div class="sourceCode" id="cb2"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true"></a><span class="co"># En main.py</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true"></a>PAGE_SIZE <span class="op">=</span> <span class="dv">3</span>  <span class="co"># hardcoded</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true"></a><span class="co"># En rss_manager.py</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true"></a>FEED_URL <span class="op">=</span> <span class="st">&quot;https://...&quot;</span>  <span class="co"># hardcoded</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true"></a><span class="co"># En orchestrator.py</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true"></a>THRESHOLD <span class="op">=</span> <span class="fl">0.2</span>  <span class="co"># hardcoded</span></span></code></pre></div>
<p><strong>Problemas:</strong> - Cambiar configuración requiere editar múltiples archivos - Difícil tener diferentes configs para dev/staging/prod - No se pueden sobrescribir valores via variables de entorno - Riesgo de inconsistencias</p>
<p><strong>Solución:</strong> <code>config.py</code> con Pydantic BaseSettings</p>
<h3 id="código-completo-explicado">3.2 Código Completo Explicado</h3>
<div class="sourceCode" id="cb3"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true"></a><span class="co">Configuración centralizada para la aplicación usando Pydantic BaseSettings.</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true"></a><span class="co">Variables de entorno toman precedencia sobre valores por defecto.</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true"></a><span class="im">from</span> typing <span class="im">import</span> List, Optional</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true"></a><span class="im">from</span> pydantic_settings <span class="im">import</span> BaseSettings</span></code></pre></div>
<p><strong>Línea por línea:</strong> - <code>from typing import List, Optional</code>: Importa tipos para anotaciones (List para listas, Optional para valores que pueden ser None) - <code>from pydantic_settings import BaseSettings</code>: Clase base de Pydantic que permite cargar configuración desde <code>.env</code> automáticamente</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true"></a><span class="kw">class</span> Settings(BaseSettings):</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;Configuración global de la aplicación.&quot;&quot;&quot;</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true"></a>    <span class="co"># Servidor</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true"></a>    HOST: <span class="bu">str</span> <span class="op">=</span> <span class="st">&quot;127.0.0.1&quot;</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true"></a>    PORT: <span class="bu">int</span> <span class="op">=</span> <span class="dv">8000</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true"></a>    LOG_LEVEL: <span class="bu">str</span> <span class="op">=</span> <span class="st">&quot;INFO&quot;</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true"></a>    DEBUG: <span class="bu">bool</span> <span class="op">=</span> <span class="va">False</span></span></code></pre></div>
<p><strong>¿Qué hace esto?</strong> - Define una clase <code>Settings</code> que hereda de <code>BaseSettings</code> - Cada atributo es una variable de configuración - <code>HOST</code>: Dirección IP donde escucha el servidor (127.0.0.1 = localhost) - <code>PORT</code>: Puerto HTTP (8000 es estándar para desarrollo) - <code>LOG_LEVEL</code>: Nivel de detalle de logs (DEBUG, INFO, WARNING, ERROR) - <code>DEBUG</code>: Modo debug (activa stack traces detallados, recarga automática)</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true"></a>    <span class="co"># Paginación</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true"></a>    PAGE_SIZE_DEFAULT: <span class="bu">int</span> <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true"></a>    PAGE_SIZE_MAX: <span class="bu">int</span> <span class="op">=</span> <span class="dv">50</span></span></code></pre></div>
<p><strong>¿Para qué sirve?</strong> - <code>PAGE_SIZE_DEFAULT</code>: Cuántos resultados devolver por defecto (5 anunciantes) - <code>PAGE_SIZE_MAX</code>: Límite máximo para evitar abusos (no más de 50 por request)</p>
<p><strong>Uso:</strong></p>
<div class="sourceCode" id="cb6"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true"></a><span class="co"># En orchestrator.py</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true"></a><span class="cf">if</span> limit <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true"></a>    limit <span class="op">=</span> settings.PAGE_SIZE_DEFAULT</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true"></a><span class="cf">if</span> limit <span class="op">&gt;</span> settings.PAGE_SIZE_MAX:</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true"></a>    limit <span class="op">=</span> settings.PAGE_SIZE_MAX</span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true"></a>    <span class="co"># CORS</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true"></a>    ALLOWED_ORIGINS: List[<span class="bu">str</span>] <span class="op">=</span> [</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true"></a>        <span class="st">&quot;https://www.barcelona-metropolitan.com&quot;</span>,</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true"></a>        <span class="st">&quot;https://barcelona-metropolitan.com&quot;</span>,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true"></a>        <span class="st">&quot;http://localhost:5500&quot;</span>,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true"></a>        <span class="st">&quot;http://localhost:3000&quot;</span>,</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true"></a>        <span class="st">&quot;http://127.0.0.1:5500&quot;</span>,</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true"></a>        <span class="st">&quot;http://127.0.0.1:3000&quot;</span>,</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true"></a>    ]</span></code></pre></div>
<p><strong>¿Qué es CORS?</strong> - Cross-Origin Resource Sharing: seguridad del navegador - Por defecto, una página en <code>barcelona-metropolitan.com</code> NO puede hacer requests AJAX a <code>api.otra-web.com</code> - <code>ALLOWED_ORIGINS</code> lista qué dominios SÍ pueden acceder a nuestra API - En producción: solo dominios reales - En desarrollo: incluimos localhost:3000, localhost:5500 para testing</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true"></a>    <span class="co"># RSS/Feeds</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true"></a>    FEED_URLS: List[<span class="bu">str</span>] <span class="op">=</span> [</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true"></a>        <span class="st">&quot;https://www.barcelona-metropolitan.com/directory/index.rss&quot;</span>,</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true"></a>    ]</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true"></a>    RSS_SYNC_HOURS: <span class="bu">int</span> <span class="op">=</span> <span class="dv">6</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true"></a>    RSS_LIMIT_PER_FEED: <span class="bu">int</span> <span class="op">=</span> <span class="dv">50</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true"></a>    RSS_MAX_ARTICLES: <span class="bu">int</span> <span class="op">=</span> <span class="dv">1000</span></span></code></pre></div>
<p><strong>Explicación:</strong> - <code>FEED_URLS</code>: Lista de feeds RSS/Atom a parsear (se pueden agregar más) - <code>RSS_SYNC_HOURS</code>: Cada cuántas horas sincronizar automáticamente (6 = 4 veces al día) - <code>RSS_LIMIT_PER_FEED</code>: Cuántos artículos tomar de cada feed (50 más recientes) - <code>RSS_MAX_ARTICLES</code>: Límite total en caché para evitar crecimiento infinito</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true"></a>    <span class="co"># Clasificación semántica</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true"></a>    SEMANTIC_MODEL: <span class="bu">str</span> <span class="op">=</span> <span class="st">&quot;paraphrase-multilingual-MiniLM-L12-v2&quot;</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true"></a>    CONFIDENCE_THRESHOLD: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.2</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true"></a>    KEYWORD_CONFIDENCE_MULTIPLIER: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.15</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true"></a>    KEYWORD_BASE_CONFIDENCE: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.25</span></span></code></pre></div>
<p><strong>¿Qué significan estos valores?</strong></p>
<ul>
<li><code>SEMANTIC_MODEL</code>: Modelo de HuggingFace para embeddings
<ul>
<li>“paraphrase-multilingual-MiniLM-L12-v2” soporta 50+ idiomas</li>
<li>Genera vectores de 384 dimensiones</li>
<li>Optimizado para similitud semántica</li>
</ul></li>
<li><code>CONFIDENCE_THRESHOLD</code>: Umbral mínimo de confianza (0.2 = 20%)
<ul>
<li>Si similitud coseno &lt; 0.2 → “Desconocida”</li>
<li>Muy bajo = acepta consultas ambiguas</li>
<li>Muy alto = rechaza consultas válidas</li>
</ul></li>
<li><code>KEYWORD_CONFIDENCE_MULTIPLIER</code> y <code>KEYWORD_BASE_CONFIDENCE</code>:
<ul>
<li>Cuando usamos fallback por keywords, calculamos confianza artificial:</li>
<li><code>confidence = KEYWORD_BASE_CONFIDENCE + (num_hits * KEYWORD_CONFIDENCE_MULTIPLIER)</code></li>
<li>Ejemplo: 2 hits → 0.25 + (2 * 0.15) = 0.55 de confianza</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb10"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true"></a>    <span class="co"># Bots</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true"></a>    MAX_KEY_POINTS: <span class="bu">int</span> <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true"></a>    MAX_ADVERTISERS_PER_QUERY: <span class="bu">int</span> <span class="op">=</span> <span class="dv">3</span></span></code></pre></div>
<ul>
<li><code>MAX_KEY_POINTS</code>: Cuántos anunciantes incluir en “puntos clave” (resumen)</li>
<li><code>MAX_ADVERTISERS_PER_QUERY</code>: Límite default si no se especifica <code>limit</code></li>
</ul>
<div class="sourceCode" id="cb11"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true"></a>    <span class="co"># Datos (rutas relativas desde raíz del proyecto)</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true"></a>    DATA_DIR: <span class="bu">str</span> <span class="op">=</span> <span class="st">&quot;data&quot;</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true"></a>    GUIDES_DIR: <span class="bu">str</span> <span class="op">=</span> <span class="st">&quot;data/guides&quot;</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true"></a>    CACHE_DIR: <span class="bu">str</span> <span class="op">=</span> <span class="st">&quot;data/cache&quot;</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true"></a>    ANUNCIANTES_FILE: <span class="bu">str</span> <span class="op">=</span> <span class="st">&quot;data/anunciantes.json&quot;</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true"></a>    ARTICLES_CACHE_FILE: <span class="bu">str</span> <span class="op">=</span> <span class="st">&quot;data/cache/articles.json&quot;</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true"></a>    ANALYTICS_DIR: <span class="bu">str</span> <span class="op">=</span> <span class="st">&quot;data/analytics&quot;</span></span></code></pre></div>
<p><strong>Rutas de archivos:</strong> - Todas relativas a la raíz del proyecto - Facilita mover el proyecto a otro directorio - Facilita testing (puedes sobrescribir con rutas temporales)</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true"></a>    <span class="kw">class</span> Config:</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true"></a>        env_file <span class="op">=</span> <span class="st">&quot;.env&quot;</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true"></a>        env_file_encoding <span class="op">=</span> <span class="st">&quot;utf-8&quot;</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true"></a>        case_sensitive <span class="op">=</span> <span class="va">False</span></span></code></pre></div>
<p><strong>Configuración de Pydantic:</strong> - <code>env_file = ".env"</code>: Busca archivo <code>.env</code> en raíz y carga variables - <code>env_file_encoding = "utf-8"</code>: Encoding para leer <code>.env</code> - <code>case_sensitive = False</code>: <code>page_size_default</code> y <code>PAGE_SIZE_DEFAULT</code> son equivalentes</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true"></a><span class="co"># Instancia global de settings</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true"></a>settings <span class="op">=</span> Settings()</span></code></pre></div>
<p><strong>Singleton:</strong> - Se crea UNA SOLA instancia al importar el módulo - Todos los archivos comparten la misma configuración - Uso: <code>from config import settings; print(settings.PAGE_SIZE_DEFAULT)</code></p>
<h3 id="cómo-usar-en-otros-módulos">3.3 Cómo Usar en Otros Módulos</h3>
<p><strong>Ejemplo en main.py:</strong></p>
<div class="sourceCode" id="cb14"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true"></a><span class="im">from</span> config <span class="im">import</span> settings</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true"></a>app <span class="op">=</span> FastAPI()</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true"></a>app.add_middleware(</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true"></a>    CORSMiddleware,</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true"></a>    allow_origins<span class="op">=</span>settings.ALLOWED_ORIGINS,  <span class="co"># ← Desde config</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true"></a>    allow_credentials<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true"></a>    allow_methods<span class="op">=</span>[<span class="st">&quot;GET&quot;</span>, <span class="st">&quot;POST&quot;</span>],</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true"></a>    allow_headers<span class="op">=</span>[<span class="st">&quot;*&quot;</span>],</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true"></a>)</span></code></pre></div>
<p><strong>Ejemplo en rss_manager.py:</strong></p>
<div class="sourceCode" id="cb15"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true"></a><span class="im">from</span> config <span class="im">import</span> settings</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true"></a><span class="kw">class</span> RSSManager:</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true"></a>        <span class="va">self</span>.feed_urls <span class="op">=</span> settings.FEED_URLS  <span class="co"># ← Desde config</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true"></a>        <span class="va">self</span>.max_articles <span class="op">=</span> settings.RSS_MAX_ARTICLES</span></code></pre></div>
<h3 id="sobrescribir-con-variables-de-entorno">3.4 Sobrescribir con Variables de Entorno</h3>
<p><strong>Archivo <code>.env</code> (no commiteado a Git):</strong></p>
<div class="sourceCode" id="cb16"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true"></a><span class="va">LOG_LEVEL=</span>DEBUG</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true"></a><span class="va">PAGE_SIZE_DEFAULT=</span>10</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true"></a><span class="va">FEED_URLS=</span>[<span class="st">&quot;https://feed1.com/rss&quot;</span>, <span class="st">&quot;https://feed2.com/atom&quot;</span>]</span></code></pre></div>
<p><strong>Al iniciar el servidor:</strong></p>
<div class="sourceCode" id="cb17"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true"></a><span class="bu">export</span> <span class="va">LOG_LEVEL=</span>DEBUG</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true"></a><span class="ex">python</span> main.py</span></code></pre></div>
<p>Pydantic carga automáticamente y sobrescribe los defaults.</p>
<h3 id="beneficios">3.5 Beneficios</h3>
<p>✅ <strong>Una sola fuente de verdad</strong> para configuración ✅ <strong>Validación automática</strong> de tipos (Pydantic valida que <code>PORT</code> sea int) ✅ <strong>Diferentes configs por entorno</strong> (dev/staging/prod) ✅ <strong>Documentación integrada</strong> (type hints + docstrings) ✅ <strong>Fácil testing</strong> (puedes mockear <code>settings</code>)</p>
<hr />
<h2 id="sistema-de-logging-botslogger.py">4. SISTEMA DE LOGGING (bots/logger.py)</h2>
<h3 id="problema-que-resuelve-1">4.1 Problema Que Resuelve</h3>
<p><strong>Antes:</strong></p>
<div class="sourceCode" id="cb18"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true"></a><span class="co"># En orchestrator.py</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true"></a><span class="bu">print</span>(<span class="st">&quot;✅ Base de datos cargada&quot;</span>)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true"></a><span class="bu">print</span>(<span class="ss">f&quot;❌ ERROR: </span><span class="sc">{e}</span><span class="ss">&quot;</span>)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true"></a><span class="co"># En main.py</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true"></a><span class="bu">print</span>(<span class="ss">f&quot;➡️ Petición recibida: </span><span class="sc">{</span>question<span class="sc">}</span><span class="ss">&quot;</span>)</span></code></pre></div>
<p><strong>Problemas:</strong> - <code>print()</code> va siempre a stdout, difícil de filtrar - Sin niveles (INFO, WARNING, ERROR) - Sin timestamps automáticos - No se puede redirigir a archivo - Mezcla logs de debug con producción</p>
<p><strong>Solución:</strong> Logger centralizado con niveles configurables</p>
<h3 id="código-completo">4.2 Código Completo</h3>
<div class="sourceCode" id="cb19"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true"></a><span class="im">import</span> logging</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true"></a><span class="im">import</span> os</span></code></pre></div>
<ul>
<li><code>logging</code>: Librería estándar de Python para logs</li>
<li><code>os</code>: Para leer variables de entorno (<code>LOG_LEVEL</code>)</li>
</ul>
<div class="sourceCode" id="cb20"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true"></a>_logger <span class="op">=</span> logging.getLogger(<span class="st">&quot;revista_expats_ai&quot;</span>)</span></code></pre></div>
<p><strong>¿Qué hace <code>getLogger()</code>?</strong> - Crea o recupera un logger con nombre “revista_expats_ai” - Permite tener múltiples loggers independientes en la app - El nombre ayuda a identificar origen de logs en producción</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true"></a><span class="cf">if</span> <span class="kw">not</span> _logger.handlers:</span></code></pre></div>
<p><strong>¿Por qué este check?</strong> - Si importamos <code>logger.py</code> múltiples veces, no queremos duplicar handlers - <code>handlers</code> son los destinos de los logs (consola, archivo, etc.) - Solo configuramos si no hay handlers previos</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true"></a>    level <span class="op">=</span> os.getenv(<span class="st">&quot;LOG_LEVEL&quot;</span>, <span class="st">&quot;INFO&quot;</span>).upper()</span></code></pre></div>
<p><strong>Niveles de logging:</strong> - <code>DEBUG</code>: Muy verbose, para desarrollo (ej: valores de variables) - <code>INFO</code>: Informativo, eventos normales (ej: “Servidor iniciado”) - <code>WARNING</code>: Advertencias, algo raro pero no crítico - <code>ERROR</code>: Errores, pero la app sigue funcionando - <code>CRITICAL</code>: Errores fatales, la app debe detenerse</p>
<p><strong>Ejemplo:</strong></p>
<div class="sourceCode" id="cb23"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true"></a><span class="bu">export</span> <span class="va">LOG_LEVEL=</span>DEBUG  # <span class="va">Muestra</span> <span class="va">todo</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true"></a><span class="bu">export</span> <span class="va">LOG_LEVEL=</span>ERROR  # <span class="va">Solo</span> <span class="va">errores</span> <span class="va">y</span> <span class="va">cr</span>íticos</span></code></pre></div>
<div class="sourceCode" id="cb24"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true"></a>    _logger.setLevel(<span class="bu">getattr</span>(logging, level, logging.INFO))</span></code></pre></div>
<ul>
<li><code>getattr(logging, level, logging.INFO)</code>:
<ul>
<li>Si <code>level="DEBUG"</code> → retorna <code>logging.DEBUG</code></li>
<li>Si <code>level="INVALID"</code> → retorna <code>logging.INFO</code> (fallback)</li>
</ul></li>
<li><code>setLevel()</code>: Establece nivel mínimo del logger</li>
</ul>
<div class="sourceCode" id="cb25"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true"></a>    handler <span class="op">=</span> logging.StreamHandler()</span></code></pre></div>
<ul>
<li>Crea un handler que escribe a <code>stdout</code> (consola)</li>
<li>En producción podrías usar <code>FileHandler()</code> para escribir a archivo</li>
</ul>
<div class="sourceCode" id="cb26"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true"></a>    formatter <span class="op">=</span> logging.Formatter(</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true"></a>        fmt<span class="op">=</span><span class="st">&quot;</span><span class="sc">%(asctime)s</span><span class="st"> </span><span class="sc">%(levelname)s</span><span class="st"> </span><span class="sc">%(name)s</span><span class="st"> - </span><span class="sc">%(message)s</span><span class="st">&quot;</span>,</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true"></a>        datefmt<span class="op">=</span><span class="st">&quot;%Y-%m-</span><span class="sc">%d</span><span class="st"> %H:%M:%S&quot;</span>,</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true"></a>    )</span></code></pre></div>
<p><strong>Formato de logs:</strong> - <code>%(asctime)s</code>: Timestamp (2025-12-19 21:30:45) - <code>%(levelname)s</code>: Nivel (INFO, ERROR, etc.) - <code>%(name)s</code>: Nombre del logger (revista_expats_ai) - <code>%(message)s</code>: El mensaje de log</p>
<p><strong>Ejemplo de output:</strong></p>
<pre><code>2025-12-19 21:30:45 INFO revista_expats_ai - Servidor iniciado
2025-12-19 21:30:50 ERROR revista_expats_ai - Error cargando BD: File not found</code></pre>
<div class="sourceCode" id="cb28"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true"></a>    handler.setFormatter(formatter)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true"></a>    _logger.addHandler(handler)</span></code></pre></div>
<ul>
<li>Asocia el formateador al handler</li>
<li>Añade el handler al logger</li>
</ul>
<div class="sourceCode" id="cb29"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true"></a>logger <span class="op">=</span> _logger</span></code></pre></div>
<ul>
<li>Exportamos como <code>logger</code> para uso externo</li>
<li>Uso: <code>from bots.logger import logger</code></li>
</ul>
<h3 id="uso-en-el-código">4.3 Uso en el Código</h3>
<p><strong>En orchestrator.py:</strong></p>
<div class="sourceCode" id="cb30"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true"></a><span class="im">from</span> .logger <span class="im">import</span> logger</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true"></a><span class="kw">class</span> Orchestrator:</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true"></a>        <span class="cf">try</span>:</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true"></a>            <span class="va">self</span>.advertisers <span class="op">=</span> json.load(f)</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true"></a>            logger.info(<span class="st">&quot;Base de datos cargada.&quot;</span>)  <span class="co"># ← INFO</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true"></a>            logger.error(<span class="ss">f&quot;ERROR cargando BD: </span><span class="sc">{e}</span><span class="ss">&quot;</span>)  <span class="co"># ← ERROR</span></span></code></pre></div>
<p><strong>En main.py:</strong></p>
<div class="sourceCode" id="cb31"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true"></a><span class="im">from</span> bots.logger <span class="im">import</span> logger</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true"></a></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true"></a><span class="at">@app.post</span>(<span class="st">&quot;/api/query&quot;</span>)</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true"></a><span class="kw">def</span> handle_query(request: QueryRequest):</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true"></a>    logger.info(<span class="ss">f&quot;Petición: &#39;</span><span class="sc">{</span>question<span class="sc">}</span><span class="ss">&#39;, limit=</span><span class="sc">{</span>request<span class="sc">.</span>limit<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true"></a>    <span class="co"># ...</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true"></a>    logger.error(<span class="ss">f&quot;ERROR en /api/query: </span><span class="sc">{e}</span><span class="ss">&quot;</span>)</span></code></pre></div>
<h3 id="ventajas">4.4 Ventajas</h3>
<p>✅ <strong>Filtrado por nivel</strong>: En dev LOG_LEVEL=DEBUG, en prod LOG_LEVEL=WARNING ✅ <strong>Timestamps automáticos</strong>: Útil para debugging y análisis ✅ <strong>Redirección fácil</strong>: Cambiar de consola a archivo sin modificar código ✅ <strong>Integración con herramientas</strong>: Compatible con Sentry, LogDNA, etc. ✅ <strong>Rendimiento</strong>: Logs DEBUG no se evalúan si LOG_LEVEL=INFO</p>
<hr />
<h2 id="utilidades-compartidas-botsutils.py">5. UTILIDADES COMPARTIDAS (bots/utils.py)</h2>
<h3 id="propósito-del-módulo">5.1 Propósito del Módulo</h3>
<p>Centralizar funciones reutilizables que se usan en múltiples bots: - Normalización de texto (minúsculas, sin acentos) - Filtrado de anunciantes por keywords - Construcción de key_points (evita duplicación)</p>
<h3 id="función-normalize">5.2 Función <code>normalize()</code></h3>
<div class="sourceCode" id="cb32"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true"></a><span class="im">import</span> unicodedata</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true"></a><span class="im">from</span> typing <span class="im">import</span> List, Dict</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true"></a><span class="im">from</span> config <span class="im">import</span> settings</span></code></pre></div>
<ul>
<li><code>unicodedata</code>: Para normalización Unicode (quitar acentos)</li>
<li><code>typing</code>: Type hints para claridad</li>
<li><code>config</code>: Acceso a configuración centralizada</li>
</ul>
<div class="sourceCode" id="cb33"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true"></a><span class="kw">def</span> normalize(s):</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true"></a>    <span class="cf">if</span> <span class="kw">not</span> s:</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true"></a>        <span class="cf">return</span> <span class="st">&quot;&quot;</span></span></code></pre></div>
<ul>
<li><strong>Guard clause</strong>: Si <code>s</code> es None o string vacío, retornar ""</li>
<li>Evita errores downstream</li>
</ul>
<div class="sourceCode" id="cb34"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true"></a>    s <span class="op">=</span> <span class="bu">str</span>(s).strip()</span></code></pre></div>
<ul>
<li><code>str(s)</code>: Convierte a string (por si acaso es int u otro tipo)</li>
<li><code>.strip()</code>: Remueve espacios al inicio/fin (" hola " → “hola”)</li>
</ul>
<div class="sourceCode" id="cb35"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true"></a>    s <span class="op">=</span> unicodedata.normalize(<span class="st">&#39;NFKD&#39;</span>, s)</span></code></pre></div>
<p><strong>¿Qué es NFKD?</strong> - Normalización Unicode: descompone caracteres acentuados - “á” → “a” + acento combinado - Permite remover acentos fácilmente</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true"></a>    s <span class="op">=</span> <span class="st">&#39;&#39;</span>.join(c <span class="cf">for</span> c <span class="kw">in</span> s <span class="cf">if</span> <span class="kw">not</span> unicodedata.combining(c))</span></code></pre></div>
<ul>
<li><strong>List comprehension</strong>: Itera cada carácter</li>
<li><code>unicodedata.combining(c)</code>: Retorna True si es acento combinado</li>
<li><code>not combining(c)</code>: Solo caracteres NO acentos</li>
<li>Resultado: “José” → “Jose”, “Español” → “Espanol”</li>
</ul>
<div class="sourceCode" id="cb37"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true"></a>    <span class="cf">return</span> s.lower()</span></code></pre></div>
<ul>
<li>Convierte a minúsculas para comparaciones case-insensitive</li>
<li>“HOLA” → “hola”</li>
</ul>
<p><strong>Ejemplo completo:</strong></p>
<div class="sourceCode" id="cb38"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true"></a>normalize(<span class="st">&quot;  José García  &quot;</span>)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true"></a><span class="co"># → &quot;jose garcia&quot;</span></span></code></pre></div>
<h3 id="función-build_key_points">5.3 Función <code>build_key_points()</code></h3>
<div class="sourceCode" id="cb39"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true"></a><span class="kw">def</span> build_key_points(advertisers: List[Dict], max_items: <span class="bu">int</span> <span class="op">=</span> <span class="va">None</span>) <span class="op">-&gt;</span> List[Dict]:</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true"></a><span class="co">    Extrae puntos clave (nombre, descripción, beneficios) de los primeros N anunciantes.</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true"></a><span class="co">    Centraliza la lógica que antes se repetía en cada bot.</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true"></a></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true"></a><span class="co">    Args:</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true"></a><span class="co">        advertisers: Lista de anunciantes</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true"></a><span class="co">        max_items: Número máximo de puntos clave (default: settings.MAX_KEY_POINTS)</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true"></a></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true"></a><span class="co">    Returns:</span></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true"></a><span class="co">        Lista de dicts con {nombre, descripcion, beneficios}</span></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true"></a><span class="co">    &quot;&quot;&quot;</span></span></code></pre></div>
<p><strong>¿Por qué existe?</strong></p>
<p><strong>ANTES (en cada bot):</strong></p>
<div class="sourceCode" id="cb40"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true"></a><span class="co"># bot_legal.py</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true"></a>key_points <span class="op">=</span> []</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true"></a><span class="cf">for</span> advertiser <span class="kw">in</span> selected_advertisers[:<span class="dv">2</span>]:</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true"></a>    point <span class="op">=</span> {</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true"></a>        <span class="st">&quot;nombre&quot;</span>: advertiser.get(<span class="st">&quot;nombre&quot;</span>),</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true"></a>        <span class="st">&quot;descripcion&quot;</span>: advertiser.get(<span class="st">&quot;descripcion&quot;</span>),</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true"></a>        <span class="st">&quot;beneficios&quot;</span>: advertiser.get(<span class="st">&quot;beneficios&quot;</span>, [])</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true"></a>    }</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true"></a>    key_points.append(point)</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true"></a></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true"></a><span class="co"># bot_accommodation.py</span></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true"></a>key_points <span class="op">=</span> []  <span class="co"># ← MISMO CÓDIGO REPETIDO</span></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true"></a><span class="cf">for</span> advertiser <span class="kw">in</span> selected_advertisers[:<span class="dv">2</span>]:</span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true"></a>    <span class="co"># ... idéntico ...</span></span></code></pre></div>
<p><strong>DESPUÉS (todos los bots):</strong></p>
<div class="sourceCode" id="cb41"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true"></a><span class="im">from</span> .utils <span class="im">import</span> build_key_points</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true"></a></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true"></a>key_points <span class="op">=</span> build_key_points(selected_advertisers)  <span class="co"># ← UNA LÍNEA</span></span></code></pre></div>
<p><strong>Código de la función:</strong></p>
<div class="sourceCode" id="cb42"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true"></a>    <span class="cf">if</span> max_items <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true"></a>        max_items <span class="op">=</span> settings.MAX_KEY_POINTS</span></code></pre></div>
<ul>
<li>Si no se especifica <code>max_items</code>, usar valor de configuración (default 2)</li>
<li>Permite sobrescribir: <code>build_key_points(ads, max_items=5)</code></li>
</ul>
<div class="sourceCode" id="cb43"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true"></a>    key_points <span class="op">=</span> []</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true"></a>    <span class="cf">for</span> advertiser <span class="kw">in</span> advertisers[:max_items]:</span></code></pre></div>
<ul>
<li><code>advertisers[:max_items]</code>: Slicing para tomar solo primeros N</li>
<li>Ejemplo: <code>[:2]</code> → primeros 2 elementos</li>
</ul>
<div class="sourceCode" id="cb44"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true"></a>        point <span class="op">=</span> {</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true"></a>            <span class="st">&quot;nombre&quot;</span>: advertiser.get(<span class="st">&quot;nombre&quot;</span>),</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true"></a>            <span class="st">&quot;descripcion&quot;</span>: advertiser.get(<span class="st">&quot;descripcion&quot;</span>),</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true"></a>            <span class="st">&quot;beneficios&quot;</span>: advertiser.get(<span class="st">&quot;beneficios&quot;</span>, [])</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true"></a>        }</span></code></pre></div>
<ul>
<li><code>.get(key, default)</code>: Método seguro de dict</li>
<li>Si key no existe → retorna default ([] para beneficios)</li>
<li>Evita KeyError</li>
</ul>
<div class="sourceCode" id="cb45"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true"></a>        key_points.append(point)</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true"></a></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true"></a>    <span class="cf">return</span> key_points</span></code></pre></div>
<ul>
<li>Construye lista de puntos clave y retorna</li>
</ul>
<p><strong>Ejemplo:</strong></p>
<div class="sourceCode" id="cb46"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true"></a>advertisers <span class="op">=</span> [</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true"></a>    {<span class="st">&quot;nombre&quot;</span>: <span class="st">&quot;Abogado A&quot;</span>, <span class="st">&quot;descripcion&quot;</span>: <span class="st">&quot;Experto NIE&quot;</span>, <span class="st">&quot;beneficios&quot;</span>: [<span class="st">&quot;24/7&quot;</span>]},</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true"></a>    {<span class="st">&quot;nombre&quot;</span>: <span class="st">&quot;Abogado B&quot;</span>, <span class="st">&quot;descripcion&quot;</span>: <span class="st">&quot;Visas&quot;</span>, <span class="st">&quot;beneficios&quot;</span>: []},</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true"></a>    {<span class="st">&quot;nombre&quot;</span>: <span class="st">&quot;Abogado C&quot;</span>, <span class="st">&quot;descripcion&quot;</span>: <span class="st">&quot;Contratos&quot;</span>, <span class="st">&quot;beneficios&quot;</span>: [<span class="st">&quot;Online&quot;</span>]}</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true"></a>]</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true"></a></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true"></a>key_points <span class="op">=</span> build_key_points(advertisers, max_items<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true"></a><span class="co"># Resultado:</span></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true"></a><span class="co"># [</span></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true"></a><span class="co">#   {&quot;nombre&quot;: &quot;Abogado A&quot;, &quot;descripcion&quot;: &quot;Experto NIE&quot;, &quot;beneficios&quot;: [&quot;24/7&quot;]},</span></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true"></a><span class="co">#   {&quot;nombre&quot;: &quot;Abogado B&quot;, &quot;descripcion&quot;: &quot;Visas&quot;, &quot;beneficios&quot;: []}</span></span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true"></a><span class="co"># ]</span></span></code></pre></div>
<h3 id="función-filter_advertisers_by_keywords">5.4 Función <code>filter_advertisers_by_keywords()</code></h3>
<div class="sourceCode" id="cb47"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true"></a><span class="kw">def</span> filter_advertisers_by_keywords(pregunta, anunciantes, keywords, search_fields<span class="op">=</span>[<span class="st">&#39;nombre&#39;</span>, <span class="st">&#39;descripcion&#39;</span>, <span class="st">&#39;perfil&#39;</span>, <span class="st">&#39;ubicacion&#39;</span>]):</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true"></a><span class="co">    Función reutilizable para filtrar una lista de anunciantes.</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true"></a></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true"></a><span class="co">    - Prioriza los anunciantes que coinciden con las palabras clave.</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true"></a><span class="co">    - Si no hay coincidencias, devuelve el resto.</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true"></a><span class="co">    &quot;&quot;&quot;</span></span></code></pre></div>
<p><strong>¿Qué hace esta función?</strong> 1. Normaliza la pregunta 2. Para cada anunciante, combina campos relevantes en un texto 3. Busca si alguna keyword está presente 4. Divide en dos listas: <code>matching</code> (con keywords) y <code>others</code> (sin keywords) 5. Ordena cada lista priorizando sponsors 6. Retorna primero los <code>matching</code>, luego <code>others</code> si no hay <code>matching</code></p>
<p><strong>Código paso a paso:</strong></p>
<div class="sourceCode" id="cb48"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true"></a>    <span class="cf">if</span> <span class="kw">not</span> anunciantes:</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true"></a>        <span class="cf">return</span> []</span></code></pre></div>
<ul>
<li>Guard clause: Si lista vacía → retornar lista vacía</li>
<li>Evita iteraciones innecesarias</li>
</ul>
<div class="sourceCode" id="cb49"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true"></a>    pregunta_norm <span class="op">=</span> normalize(pregunta <span class="kw">or</span> <span class="st">&quot;&quot;</span>)</span></code></pre></div>
<ul>
<li>Normaliza la pregunta del usuario</li>
<li><code>pregunta or ""</code>: Si pregunta es None → usar ""</li>
</ul>
<div class="sourceCode" id="cb50"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true"></a>    matching, others <span class="op">=</span> [], []</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true"></a>    <span class="cf">for</span> a <span class="kw">in</span> anunciantes:</span></code></pre></div>
<ul>
<li><code>matching</code>: Anunciantes que coinciden con keywords</li>
<li><code>others</code>: Anunciantes que NO coinciden</li>
<li>Iteramos cada anunciante</li>
</ul>
<div class="sourceCode" id="cb51"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true"></a>        combined_text <span class="op">=</span> <span class="st">&#39; &#39;</span>.join([<span class="bu">str</span>(a.get(k, <span class="st">&#39;&#39;</span>)) <span class="cf">for</span> k <span class="kw">in</span> search_fields])</span></code></pre></div>
<p><strong>Explicación detallada:</strong> - <code>search_fields</code>: Por default <code>['nombre', 'descripcion', 'perfil', 'ubicacion']</code> - Para cada field, obtiene valor del dict: <code>a.get('nombre', '')</code> - <code>str()</code>: Convierte a string por seguridad - <code>' '.join()</code>: Une con espacios</p>
<p><strong>Ejemplo:</strong></p>
<div class="sourceCode" id="cb52"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true"></a>a <span class="op">=</span> {</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true"></a>    <span class="st">&quot;nombre&quot;</span>: <span class="st">&quot;Clínica Dental ABC&quot;</span>,</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true"></a>    <span class="st">&quot;descripcion&quot;</span>: <span class="st">&quot;Dentista especializado en implantes&quot;</span>,</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true"></a>    <span class="st">&quot;ubicacion&quot;</span>: <span class="st">&quot;Eixample, Barcelona&quot;</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true"></a>}</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true"></a>search_fields <span class="op">=</span> [<span class="st">&#39;nombre&#39;</span>, <span class="st">&#39;descripcion&#39;</span>, <span class="st">&#39;ubicacion&#39;</span>]</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true"></a>combined_text <span class="op">=</span> <span class="st">&quot;Clínica Dental ABC Dentista especializado en implantes Eixample, Barcelona&quot;</span></span></code></pre></div>
<div class="sourceCode" id="cb53"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true"></a>        combined_norm <span class="op">=</span> normalize(combined_text)</span></code></pre></div>
<ul>
<li>Normaliza el texto combinado</li>
<li>“Clínica Dental ABC…” → “clinica dental abc dentista…”</li>
</ul>
<div class="sourceCode" id="cb54"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true"></a>        found <span class="op">=</span> <span class="bu">any</span>(kw <span class="kw">in</span> pregunta_norm <span class="kw">or</span> kw <span class="kw">in</span> combined_norm <span class="cf">for</span> kw <span class="kw">in</span> keywords)</span></code></pre></div>
<p><strong>Explicación de <code>any()</code>:</strong> - <code>any(iterable)</code>: Retorna True si al menos un elemento es True - Para cada keyword, verifica: - ¿Está en <code>pregunta_norm</code>? (ej: “dentista” en “necesito un dentista”) - ¿Está en <code>combined_norm</code>? (ej: “dentista” en campos del anunciante) - Si alguna keyword coincide → <code>found = True</code></p>
<p><strong>Ejemplo:</strong></p>
<div class="sourceCode" id="cb55"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true"></a>keywords <span class="op">=</span> [<span class="st">&quot;dentista&quot;</span>, <span class="st">&quot;dental&quot;</span>, <span class="st">&quot;implante&quot;</span>]</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true"></a>pregunta_norm <span class="op">=</span> <span class="st">&quot;necesito un dentista&quot;</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true"></a>combined_norm <span class="op">=</span> <span class="st">&quot;clinica dental abc dentista especializado implantes...&quot;</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true"></a></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true"></a><span class="co"># Checking:</span></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true"></a><span class="co"># &quot;dentista&quot; in &quot;necesito un dentista&quot; → True ✓</span></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true"></a><span class="co"># Result: found = True</span></span></code></pre></div>
<div class="sourceCode" id="cb56"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true"></a>        (matching <span class="cf">if</span> found <span class="cf">else</span> others).append(a)</span></code></pre></div>
<ul>
<li><strong>Ternary in Python</strong>: <code>(A if condition else B).method()</code></li>
<li>Si <code>found=True</code> → append a <code>matching</code></li>
<li>Si <code>found=False</code> → append a <code>others</code></li>
</ul>
<div class="sourceCode" id="cb57"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true"></a>    <span class="kw">def</span> sponsor_key(item):</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true"></a>        flag <span class="op">=</span> item.get(<span class="st">&#39;es_anunciante&#39;</span>) <span class="kw">or</span> item.get(<span class="st">&#39;sponsored&#39;</span>) <span class="kw">or</span> item.get(<span class="st">&#39;featured&#39;</span>)</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true"></a>        <span class="cf">return</span> <span class="dv">1</span> <span class="cf">if</span> flag <span class="cf">else</span> <span class="dv">0</span></span></code></pre></div>
<p><strong>Función helper para sorting:</strong> - Busca si anunciante tiene flag de sponsor/featured - Si tiene cualquiera de los flags → retorna 1 - Si no tiene ninguno → retorna 0 - Se usa para ordenar (1 viene antes que 0 con <code>reverse=True</code>)</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true"></a>    <span class="cf">if</span> matching:</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true"></a>        matching.sort(key<span class="op">=</span>sponsor_key, reverse<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true"></a>        <span class="cf">return</span> matching</span></code></pre></div>
<ul>
<li>Si hay anunciantes matching:
<ul>
<li>Los ordena por <code>sponsor_key</code> descendente</li>
<li>Sponsors (key=1) primero, normales (key=0) después</li>
<li>Retorna solo los <code>matching</code></li>
</ul></li>
</ul>
<div class="sourceCode" id="cb59"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true"></a>    <span class="cf">else</span>:</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true"></a>        others.sort(key<span class="op">=</span>sponsor_key, reverse<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true"></a>        <span class="cf">return</span> others</span></code></pre></div>
<ul>
<li>Si NO hay matching:
<ul>
<li>Ordena <code>others</code> por sponsor</li>
<li>Retorna todos (mejor algo que nada)</li>
</ul></li>
</ul>
<p><strong>Ejemplo completo:</strong></p>
<div class="sourceCode" id="cb60"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true"></a>pregunta <span class="op">=</span> <span class="st">&quot;Necesito un dentista urgente&quot;</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true"></a>anunciantes <span class="op">=</span> [</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true"></a>    {<span class="st">&quot;nombre&quot;</span>: <span class="st">&quot;Hotel BCN&quot;</span>, <span class="st">&quot;descripcion&quot;</span>: <span class="st">&quot;...&quot;</span>, <span class="st">&quot;es_anunciante&quot;</span>: <span class="va">False</span>},</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true"></a>    {<span class="st">&quot;nombre&quot;</span>: <span class="st">&quot;Clínica Dental&quot;</span>, <span class="st">&quot;descripcion&quot;</span>: <span class="st">&quot;implantes&quot;</span>, <span class="st">&quot;es_anunciante&quot;</span>: <span class="va">True</span>},</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true"></a>    {<span class="st">&quot;nombre&quot;</span>: <span class="st">&quot;Dentista López&quot;</span>, <span class="st">&quot;descripcion&quot;</span>: <span class="st">&quot;urgencias&quot;</span>, <span class="st">&quot;es_anunciante&quot;</span>: <span class="va">False</span>},</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true"></a>]</span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true"></a>keywords <span class="op">=</span> [<span class="st">&quot;dentista&quot;</span>, <span class="st">&quot;dental&quot;</span>, <span class="st">&quot;clinica&quot;</span>]</span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true"></a></span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true"></a>result <span class="op">=</span> filter_advertisers_by_keywords(pregunta, anunciantes, keywords)</span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true"></a><span class="co"># → [</span></span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true"></a><span class="co">#     {&quot;nombre&quot;: &quot;Clínica Dental&quot;, ...},  # ← Sponsor primero</span></span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true"></a><span class="co">#     {&quot;nombre&quot;: &quot;Dentista López&quot;, ...}    # ← Match pero no sponsor</span></span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true"></a><span class="co">#   ]</span></span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true"></a><span class="co"># Hotel BCN NO está en resultado (no match)</span></span></code></pre></div>
<h3 id="beneficios-de-utils.py">5.5 Beneficios de utils.py</h3>
<p>✅ <strong>DRY (Don’t Repeat Yourself)</strong>: Código compartido en un solo lugar ✅ <strong>Mantenibilidad</strong>: Cambios en una función afectan a todos los bots ✅ <strong>Testing</strong>: Fácil testear funciones aisladas ✅ <strong>Claridad</strong>: Los bots quedan más simples y enfocados</p>
<hr />
<p><em>[CONTINÚA EN PARTE 2 - El reporte completo tiene más de 15,000 palabras. ¿Quieres que genere el resto en archivos separados o continúo aquí?]</em></p>
<hr />
<h2 id="gestor-de-contenido-editorial-botscontent_manager.py">6. GESTOR DE CONTENIDO EDITORIAL (bots/content_manager.py)</h2>
<h3 id="objetivo">6.1 Objetivo</h3>
<p>Cargar y buscar guías editoriales (JSON) que están en <code>data/guides/</code>. Estas guías son contenido de la revista (ej: “Guía NIE Completa”, “Sistema de Salud en Barcelona”).</p>
<h3 id="código-completo-explicado-1">6.2 Código Completo Explicado</h3>
<div class="sourceCode" id="cb61"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true"></a><span class="im">import</span> json</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true"></a><span class="im">from</span> typing <span class="im">import</span> List, Dict, Optional</span></code></pre></div>
<ul>
<li><code>pathlib.Path</code>: Manejo moderno de rutas (mejor que <code>os.path</code>)</li>
<li><code>typing</code>: Type hints para documentación</li>
</ul>
<div class="sourceCode" id="cb62"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true"></a><span class="kw">class</span> ContentManager:</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true"></a>        <span class="va">self</span>.base_dir <span class="op">=</span> Path(<span class="va">__file__</span>).resolve().parent.parent</span></code></pre></div>
<p><strong>¿Qué hace esto?</strong> - <code>__file__</code>: Ruta del archivo actual (content_manager.py) - <code>.resolve()</code>: Ruta absoluta (resuelve symlinks) - <code>.parent</code>: Sube un nivel (de <code>bots/</code> a raíz del proyecto) - <code>.parent</code> otra vez: Desde raíz</p>
<p><strong>Resultado:</strong> Si <code>content_manager.py</code> está en <code>/proyecto/bots/content_manager.py</code>: - <code>base_dir = /proyecto/</code></p>
<div class="sourceCode" id="cb63"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true"></a>        <span class="va">self</span>.guides_dir <span class="op">=</span> <span class="va">self</span>.base_dir <span class="op">/</span> <span class="st">&quot;data&quot;</span> <span class="op">/</span> <span class="st">&quot;guides&quot;</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true"></a>        <span class="va">self</span>.articles_dir <span class="op">=</span> <span class="va">self</span>.base_dir <span class="op">/</span> <span class="st">&quot;data&quot;</span> <span class="op">/</span> <span class="st">&quot;articles&quot;</span></span></code></pre></div>
<ul>
<li><code>/</code> operator de <code>Path</code>: Concatena rutas de forma segura</li>
<li><code>self.guides_dir = /proyecto/data/guides/</code></li>
</ul>
<div class="sourceCode" id="cb64"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true"></a>        <span class="va">self</span>.guides <span class="op">=</span> <span class="va">self</span>._load_guides()</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true"></a>        <span class="bu">print</span>(<span class="ss">f&quot;✅ Contenido editorial cargado: </span><span class="sc">{</span><span class="bu">len</span>(<span class="va">self</span>.guides)<span class="sc">}</span><span class="ss"> guías disponibles&quot;</span>)</span></code></pre></div>
<ul>
<li>Carga todas las guías al inicializar</li>
<li>Print feedback (debería ser logger, pero esto se escribió antes)</li>
</ul>
<div class="sourceCode" id="cb65"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true"></a>    <span class="kw">def</span> _load_guides(<span class="va">self</span>) <span class="op">-&gt;</span> List[Dict]:</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true"></a>        <span class="co">&quot;&quot;&quot;Carga todas las guías disponibles&quot;&quot;&quot;</span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true"></a>        guides <span class="op">=</span> []</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true"></a>        <span class="cf">if</span> <span class="va">self</span>.guides_dir.exists():</span></code></pre></div>
<ul>
<li><code>_load_guides</code>: Método privado (prefijo <code>_</code>)</li>
<li>Verifica si directorio existe antes de iterar</li>
</ul>
<div class="sourceCode" id="cb66"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true"></a>            <span class="cf">for</span> guide_file <span class="kw">in</span> <span class="va">self</span>.guides_dir.glob(<span class="st">&quot;*.json&quot;</span>):</span></code></pre></div>
<ul>
<li><code>.glob("*.json")</code>: Encuentra todos los archivos <code>.json</code></li>
<li>Ejemplo: <code>nie_completa.json</code>, <code>sistema_salud.json</code></li>
</ul>
<div class="sourceCode" id="cb67"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true"></a>                <span class="cf">try</span>:</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true"></a>                    <span class="cf">with</span> <span class="bu">open</span>(guide_file, <span class="st">&#39;r&#39;</span>, encoding<span class="op">=</span><span class="st">&#39;utf-8&#39;</span>) <span class="im">as</span> f:</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true"></a>                        guide <span class="op">=</span> json.load(f)</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true"></a>                        guide[<span class="st">&#39;tipo&#39;</span>] <span class="op">=</span> <span class="st">&#39;guia&#39;</span></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true"></a>                        guides.append(guide)</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true"></a>                <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true"></a>                    <span class="bu">print</span>(<span class="ss">f&quot;⚠️  Error cargando </span><span class="sc">{</span>guide_file<span class="sc">}</span><span class="ss">: </span><span class="sc">{e}</span><span class="ss">&quot;</span>)</span></code></pre></div>
<ul>
<li>Context manager (<code>with</code>): Auto-cierra archivo</li>
<li><code>json.load(f)</code>: Parsea JSON a dict de Python</li>
<li>Añade campo <code>tipo='guia'</code> para identificación</li>
<li>Try/except: Si un archivo está corrupto, continúa con los demás</li>
</ul>
<div class="sourceCode" id="cb68"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true"></a>        <span class="cf">return</span> guides</span></code></pre></div>
<h3 id="función-search_guides">6.3 Función <code>search_guides()</code></h3>
<div class="sourceCode" id="cb69"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true"></a>    <span class="kw">def</span> search_guides(<span class="va">self</span>, keywords: List[<span class="bu">str</span>], categoria: <span class="bu">str</span> <span class="op">=</span> <span class="va">None</span>) <span class="op">-&gt;</span> List[Dict]:</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true"></a>        <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true"></a><span class="co">        Busca guías relevantes basándose en keywords y categoría.</span></span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true"></a></span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true"></a><span class="co">        Args:</span></span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true"></a><span class="co">            keywords: Lista de palabras clave para buscar</span></span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true"></a><span class="co">            categoria: Categoría específica (Healthcare, Legal, etc.)</span></span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true"></a></span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true"></a><span class="co">        Returns:</span></span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true"></a><span class="co">            Lista de guías relevantes ordenadas por relevancia</span></span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true"></a><span class="co">        &quot;&quot;&quot;</span></span></code></pre></div>
<p><strong>Sistema de scoring:</strong></p>
<div class="sourceCode" id="cb70"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true"></a>        relevant_guides <span class="op">=</span> []</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true"></a></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true"></a>        <span class="cf">for</span> guide <span class="kw">in</span> <span class="va">self</span>.guides:</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true"></a>            score <span class="op">=</span> <span class="dv">0</span></span></code></pre></div>
<ul>
<li>Inicia score en 0 para cada guía</li>
<li>Irá acumulando puntos</li>
</ul>
<div class="sourceCode" id="cb71"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true"></a>            <span class="co"># Coincidencia de categoría (peso 3)</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true"></a>            <span class="cf">if</span> categoria <span class="kw">and</span> guide.get(<span class="st">&#39;categoria&#39;</span>) <span class="op">==</span> categoria:</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true"></a>                score <span class="op">+=</span> <span class="dv">3</span></span></code></pre></div>
<ul>
<li>Si la guía es de la categoría correcta → +3 puntos</li>
<li>Ejemplo: Busco “Legal”, guía es “Legal” → score=3</li>
</ul>
<div class="sourceCode" id="cb72"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true"></a>            <span class="co"># Coincidencia en keywords de la guía (peso 2)</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true"></a>            guide_keywords <span class="op">=</span> [k.lower() <span class="cf">for</span> k <span class="kw">in</span> guide.get(<span class="st">&#39;keywords&#39;</span>, [])]</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true"></a>            <span class="cf">for</span> keyword <span class="kw">in</span> keywords:</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true"></a>                <span class="cf">if</span> <span class="bu">any</span>(keyword.lower() <span class="kw">in</span> gk <span class="cf">for</span> gk <span class="kw">in</span> guide_keywords):</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true"></a>                    score <span class="op">+=</span> <span class="dv">2</span></span></code></pre></div>
<ul>
<li>Cada guía tiene un array de keywords</li>
<li>Si keyword del usuario coincide con keyword de guía → +2</li>
<li><code>any()</code>: Al menos una coincidencia</li>
</ul>
<div class="sourceCode" id="cb73"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true"></a>            <span class="co"># Coincidencia en título (peso 1)</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true"></a>            titulo <span class="op">=</span> guide.get(<span class="st">&#39;titulo&#39;</span>, <span class="st">&#39;&#39;</span>).lower()</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true"></a>            <span class="cf">for</span> keyword <span class="kw">in</span> keywords:</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true"></a>                <span class="cf">if</span> keyword.lower() <span class="kw">in</span> titulo:</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true"></a>                    score <span class="op">+=</span> <span class="dv">1</span></span></code></pre></div>
<ul>
<li>Si keyword está en el título → +1</li>
<li>Peso menor porque título puede tener palabras genéricas</li>
</ul>
<div class="sourceCode" id="cb74"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true"></a>            <span class="cf">if</span> score <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true"></a>                guide_copy <span class="op">=</span> guide.copy()</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true"></a>                guide_copy[<span class="st">&#39;relevancia&#39;</span>] <span class="op">=</span> score</span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true"></a>                relevant_guides.append(guide_copy)</span></code></pre></div>
<ul>
<li>Solo añade guías con score &gt; 0</li>
<li>Copia la guía y añade campo <code>relevancia</code></li>
</ul>
<div class="sourceCode" id="cb75"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true"></a>        <span class="co"># Ordenar por relevancia</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true"></a>        relevant_guides.sort(key<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">&#39;relevancia&#39;</span>], reverse<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true"></a>        <span class="cf">return</span> relevant_guides</span></code></pre></div>
<ul>
<li>Ordena de mayor a menor relevancia</li>
<li>Las más relevantes primero</li>
</ul>
<p><strong>Ejemplo:</strong></p>
<div class="sourceCode" id="cb76"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true"></a>keywords <span class="op">=</span> [<span class="st">&quot;nie&quot;</span>, <span class="st">&quot;residencia&quot;</span>, <span class="st">&quot;visa&quot;</span>]</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true"></a>categoria <span class="op">=</span> <span class="st">&quot;Legal and Financial&quot;</span></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true"></a></span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true"></a>guides <span class="op">=</span> [</span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true"></a>    {<span class="st">&quot;titulo&quot;</span>: <span class="st">&quot;Guía NIE Completa&quot;</span>, <span class="st">&quot;categoria&quot;</span>: <span class="st">&quot;Legal and Financial&quot;</span>, <span class="st">&quot;keywords&quot;</span>: [<span class="st">&quot;nie&quot;</span>, <span class="st">&quot;extranjeria&quot;</span>]},</span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true"></a>    {<span class="st">&quot;titulo&quot;</span>: <span class="st">&quot;Trabajar en Barcelona&quot;</span>, <span class="st">&quot;categoria&quot;</span>: <span class="st">&quot;Work&quot;</span>, <span class="st">&quot;keywords&quot;</span>: [<span class="st">&quot;empleo&quot;</span>, <span class="st">&quot;visa&quot;</span>]},</span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true"></a>]</span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true"></a></span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true"></a>result <span class="op">=</span> content_manager.search_guides(keywords, categoria)</span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true"></a><span class="co"># Guía 1: cat match(+3) + kw &quot;nie&quot;(+2) + título &quot;nie&quot;(+1) = 6</span></span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true"></a><span class="co"># Guía 2: kw &quot;visa&quot;(+2) = 2</span></span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true"></a><span class="co"># Orden: [Guía 1, Guía 2]</span></span></code></pre></div>
<h3 id="función-get_guide_summary">6.4 Función <code>get_guide_summary()</code></h3>
<div class="sourceCode" id="cb77"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true"></a>    <span class="kw">def</span> get_guide_summary(<span class="va">self</span>, guide: Dict) <span class="op">-&gt;</span> Dict:</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true"></a>        <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true"></a><span class="co">        Devuelve un resumen corto de la guía para mostrar en el chat.</span></span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true"></a>        <span class="cf">return</span> {</span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true"></a>            <span class="st">&quot;tipo&quot;</span>: <span class="st">&quot;guia_revista&quot;</span>,</span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true"></a>            <span class="st">&quot;titulo&quot;</span>: guide.get(<span class="st">&#39;titulo&#39;</span>),</span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true"></a>            <span class="st">&quot;resumen&quot;</span>: guide.get(<span class="st">&#39;resumen&#39;</span>),</span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true"></a>            <span class="st">&quot;slug&quot;</span>: guide.get(<span class="st">&#39;slug&#39;</span>),</span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true"></a>            <span class="st">&quot;url&quot;</span>: <span class="ss">f&quot;/revista/guias/</span><span class="sc">{</span>guide<span class="sc">.</span>get(<span class="st">&#39;slug&#39;</span>)<span class="sc">}</span><span class="ss">&quot;</span>,</span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true"></a>            <span class="st">&quot;categoria&quot;</span>: guide.get(<span class="st">&#39;categoria&#39;</span>)</span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true"></a>        }</span></code></pre></div>
<ul>
<li>Extrae solo campos relevantes para el frontend</li>
<li>Construye URL dinámica usando slug</li>
<li>Ejemplo: slug=“nie-completa” → url=“/revista/guias/nie-completa”</li>
</ul>
<hr />
<h2 id="gestor-de-feeds-rss-botsrss_manager.py">7. GESTOR DE FEEDS RSS (bots/rss_manager.py)</h2>
<h3 id="objetivo-1">7.1 Objetivo</h3>
<p>Parsear los feeds RSS/Atom de Barcelona Metropolitan, almacenar artículos en caché local y proveer búsqueda por palabras clave y por categoría.</p>
<h3 id="código-explicado-línea-a-línea-fragmentos-clave">7.2 Código Explicado Línea a Línea (fragmentos clave)</h3>
<div class="sourceCode" id="cb78"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true"></a><span class="co">RSS Feed Manager: parsea feeds de la revista y cachea artículos localmente.</span></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true"></a><span class="co">Actualiza cada 6-12 horas en background.</span></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true"></a><span class="co">&quot;&quot;&quot;</span></span></code></pre></div>
<ul>
<li>Docstring que describe el propósito del módulo y la frecuencia de actualización.</li>
</ul>
<div class="sourceCode" id="cb79"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true"></a><span class="im">import</span> json</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true"></a><span class="im">import</span> feedparser</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true"></a><span class="im">from</span> typing <span class="im">import</span> List, Dict, Optional</span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true"></a><span class="im">from</span> .logger <span class="im">import</span> logger</span></code></pre></div>
<ul>
<li><code>feedparser</code>: librería para parsear RSS/Atom.<br />
</li>
<li><code>Path</code>: manejo de rutas.<br />
</li>
<li><code>datetime</code>: timestamps para <code>synced_at</code>.<br />
</li>
<li><code>logger</code>: logs estructurados.</li>
</ul>
<div class="sourceCode" id="cb80"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true"></a><span class="kw">class</span> RSSManager:</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true"></a>        <span class="va">self</span>.base_dir <span class="op">=</span> Path(<span class="va">__file__</span>).resolve().parent.parent</span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true"></a>        <span class="va">self</span>.cache_dir <span class="op">=</span> <span class="va">self</span>.base_dir <span class="op">/</span> <span class="st">&quot;data&quot;</span> <span class="op">/</span> <span class="st">&quot;cache&quot;</span></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true"></a>        <span class="va">self</span>.cache_dir.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true"></a>        <span class="va">self</span>.articles_cache <span class="op">=</span> <span class="va">self</span>.cache_dir <span class="op">/</span> <span class="st">&quot;articles.json&quot;</span></span></code></pre></div>
<ul>
<li>Calcula ruta base y asegura que <code>data/cache</code> exista.<br />
</li>
<li>Define archivo <code>articles.json</code> para caché.</li>
</ul>
<div class="sourceCode" id="cb81"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true"></a>        <span class="va">self</span>.feed_urls <span class="op">=</span> [</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true"></a>            <span class="st">&quot;https://www.barcelona-metropolitan.com/directory/index.rss&quot;</span>,</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true"></a>        ]</span></code></pre></div>
<ul>
<li>Lista de feeds a sincronizar. Se pueden añadir más feeds.</li>
</ul>
<div class="sourceCode" id="cb82"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true"></a>        <span class="va">self</span>.articles <span class="op">=</span> <span class="va">self</span>.load_cache()</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true"></a>        logger.info(<span class="ss">f&quot;RSS Manager inicializado. </span><span class="sc">{</span><span class="bu">len</span>(<span class="va">self</span>.articles)<span class="sc">}</span><span class="ss"> artículos en caché.&quot;</span>)</span></code></pre></div>
<ul>
<li>Carga caché al iniciar y reporta cantidad en logs.</li>
</ul>
<div class="sourceCode" id="cb83"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true"></a>    <span class="kw">def</span> load_cache(<span class="va">self</span>) <span class="op">-&gt;</span> List[Dict]:</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true"></a>        <span class="cf">if</span> <span class="va">self</span>.articles_cache.exists():</span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true"></a>            <span class="cf">try</span>:</span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true"></a>                <span class="cf">with</span> <span class="bu">open</span>(<span class="va">self</span>.articles_cache, <span class="st">&#39;r&#39;</span>, encoding<span class="op">=</span><span class="st">&#39;utf-8&#39;</span>) <span class="im">as</span> f:</span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true"></a>                    <span class="cf">return</span> json.load(f)</span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true"></a>            <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true"></a>                logger.warning(<span class="ss">f&quot;Error cargando caché: </span><span class="sc">{e}</span><span class="ss">&quot;</span>)</span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true"></a>        <span class="cf">return</span> []</span></code></pre></div>
<ul>
<li>Lectura segura del archivo de caché con manejo de errores.</li>
</ul>
<div class="sourceCode" id="cb84"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true"></a>    <span class="kw">def</span> save_cache(<span class="va">self</span>):</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true"></a>        <span class="cf">try</span>:</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true"></a>            <span class="cf">with</span> <span class="bu">open</span>(<span class="va">self</span>.articles_cache, <span class="st">&#39;w&#39;</span>, encoding<span class="op">=</span><span class="st">&#39;utf-8&#39;</span>) <span class="im">as</span> f:</span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true"></a>                json.dump(<span class="va">self</span>.articles, f, ensure_ascii<span class="op">=</span><span class="va">False</span>, indent<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true"></a>            logger.error(<span class="ss">f&quot;Error guardando caché: </span><span class="sc">{e}</span><span class="ss">&quot;</span>)</span></code></pre></div>
<ul>
<li>Persistencia de artículos en disco en formato JSON legible.</li>
</ul>
<div class="sourceCode" id="cb85"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true"></a>    <span class="kw">def</span> sync_feeds(<span class="va">self</span>) <span class="op">-&gt;</span> <span class="bu">int</span>:</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true"></a>        new_count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true"></a>        existing_urls <span class="op">=</span> {a.get(<span class="st">&#39;url&#39;</span>) <span class="cf">for</span> a <span class="kw">in</span> <span class="va">self</span>.articles}</span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true"></a>        <span class="cf">for</span> feed_url <span class="kw">in</span> <span class="va">self</span>.feed_urls:</span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true"></a>            <span class="cf">try</span>:</span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true"></a>                logger.info(<span class="ss">f&quot;Parseando feed: </span><span class="sc">{</span>feed_url<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true"></a>                feed <span class="op">=</span> feedparser.parse(feed_url)</span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true"></a>                <span class="cf">if</span> <span class="kw">not</span> feed.entries:</span>
<span id="cb85-9"><a href="#cb85-9" aria-hidden="true"></a>                    logger.warning(<span class="ss">f&quot;Feed vacío o no accesible: </span><span class="sc">{</span>feed_url<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb85-10"><a href="#cb85-10" aria-hidden="true"></a>                    <span class="cf">continue</span></span>
<span id="cb85-11"><a href="#cb85-11" aria-hidden="true"></a>                entries_count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb85-12"><a href="#cb85-12" aria-hidden="true"></a>                <span class="cf">for</span> entry <span class="kw">in</span> feed.entries[:<span class="dv">50</span>]:</span>
<span id="cb85-13"><a href="#cb85-13" aria-hidden="true"></a>                    article <span class="op">=</span> {</span>
<span id="cb85-14"><a href="#cb85-14" aria-hidden="true"></a>                        <span class="st">&quot;url&quot;</span>: entry.get(<span class="st">&#39;link&#39;</span>, <span class="st">&#39;&#39;</span>) <span class="kw">or</span> entry.get(<span class="st">&#39;id&#39;</span>, <span class="st">&#39;&#39;</span>),</span>
<span id="cb85-15"><a href="#cb85-15" aria-hidden="true"></a>                        <span class="st">&quot;title&quot;</span>: entry.get(<span class="st">&#39;title&#39;</span>, <span class="st">&#39;Sin título&#39;</span>),</span>
<span id="cb85-16"><a href="#cb85-16" aria-hidden="true"></a>                        <span class="st">&quot;description&quot;</span>: entry.get(<span class="st">&#39;summary&#39;</span>, entry.get(<span class="st">&#39;description&#39;</span>, <span class="st">&#39;&#39;</span>))[:<span class="dv">500</span>],</span>
<span id="cb85-17"><a href="#cb85-17" aria-hidden="true"></a>                        <span class="st">&quot;published&quot;</span>: entry.get(<span class="st">&#39;published&#39;</span>, entry.get(<span class="st">&#39;updated&#39;</span>, <span class="st">&#39;&#39;</span>)),</span>
<span id="cb85-18"><a href="#cb85-18" aria-hidden="true"></a>                        <span class="st">&quot;categories&quot;</span>: [t.get(<span class="st">&#39;term&#39;</span>) <span class="cf">if</span> <span class="bu">isinstance</span>(t, <span class="bu">dict</span>) <span class="cf">else</span> <span class="bu">str</span>(t) <span class="cf">for</span> t <span class="kw">in</span> entry.get(<span class="st">&#39;tags&#39;</span>, [])],</span>
<span id="cb85-19"><a href="#cb85-19" aria-hidden="true"></a>                        <span class="st">&quot;source&quot;</span>: feed.feed.get(<span class="st">&#39;title&#39;</span>, <span class="st">&#39;Barcelona Metropolitan&#39;</span>),</span>
<span id="cb85-20"><a href="#cb85-20" aria-hidden="true"></a>                        <span class="st">&quot;synced_at&quot;</span>: datetime.utcnow().isoformat()</span>
<span id="cb85-21"><a href="#cb85-21" aria-hidden="true"></a>                    }</span>
<span id="cb85-22"><a href="#cb85-22" aria-hidden="true"></a>                    <span class="cf">if</span> article[<span class="st">&#39;url&#39;</span>] <span class="kw">and</span> article[<span class="st">&#39;url&#39;</span>] <span class="kw">not</span> <span class="kw">in</span> existing_urls:</span>
<span id="cb85-23"><a href="#cb85-23" aria-hidden="true"></a>                        <span class="va">self</span>.articles.append(article)</span>
<span id="cb85-24"><a href="#cb85-24" aria-hidden="true"></a>                        existing_urls.add(article[<span class="st">&#39;url&#39;</span>])</span>
<span id="cb85-25"><a href="#cb85-25" aria-hidden="true"></a>                        new_count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb85-26"><a href="#cb85-26" aria-hidden="true"></a>                        entries_count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb85-27"><a href="#cb85-27" aria-hidden="true"></a>                logger.info(<span class="ss">f&quot;Feed &#39;</span><span class="sc">{</span>feed<span class="sc">.</span>feed<span class="sc">.</span>get(<span class="st">&#39;title&#39;</span>, <span class="st">&#39;Unknown&#39;</span>)<span class="sc">}</span><span class="ss">&#39;: </span><span class="sc">{</span>entries_count<span class="sc">}</span><span class="ss"> nuevas entradas parseadas.&quot;</span>)</span>
<span id="cb85-28"><a href="#cb85-28" aria-hidden="true"></a>            <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb85-29"><a href="#cb85-29" aria-hidden="true"></a>                logger.error(<span class="ss">f&quot;Error parseando </span><span class="sc">{</span>feed_url<span class="sc">}</span><span class="ss">: </span><span class="sc">{e}</span><span class="ss">&quot;</span>)</span>
<span id="cb85-30"><a href="#cb85-30" aria-hidden="true"></a>        <span class="cf">if</span> <span class="bu">len</span>(<span class="va">self</span>.articles) <span class="op">&gt;</span> <span class="dv">1000</span>:</span>
<span id="cb85-31"><a href="#cb85-31" aria-hidden="true"></a>            <span class="va">self</span>.articles <span class="op">=</span> <span class="bu">sorted</span>(<span class="va">self</span>.articles, key<span class="op">=</span><span class="kw">lambda</span> x: x.get(<span class="st">&#39;synced_at&#39;</span>, <span class="st">&#39;&#39;</span>), reverse<span class="op">=</span><span class="va">True</span>)[:<span class="dv">1000</span>]</span>
<span id="cb85-32"><a href="#cb85-32" aria-hidden="true"></a>        <span class="va">self</span>.save_cache()</span>
<span id="cb85-33"><a href="#cb85-33" aria-hidden="true"></a>        logger.info(<span class="ss">f&quot;Sync completado: </span><span class="sc">{</span>new_count<span class="sc">}</span><span class="ss"> artículos nuevos. Total: </span><span class="sc">{</span><span class="bu">len</span>(<span class="va">self</span>.articles)<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb85-34"><a href="#cb85-34" aria-hidden="true"></a>        <span class="cf">return</span> new_count</span></code></pre></div>
<ul>
<li>Recorre todos los feeds, parsea entradas y evita duplicados por URL.<br />
</li>
<li>Limita a 50 por feed y máx. 1000 en caché.<br />
</li>
<li>Guarda caché y retorna número de nuevos artículos.</li>
</ul>
<div class="sourceCode" id="cb86"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true"></a>    <span class="kw">def</span> search_articles(<span class="va">self</span>, keywords: List[<span class="bu">str</span>], limit: <span class="bu">int</span> <span class="op">=</span> <span class="dv">5</span>) <span class="op">-&gt;</span> List[Dict]:</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true"></a>        <span class="cf">if</span> <span class="kw">not</span> keywords <span class="kw">or</span> <span class="kw">not</span> <span class="va">self</span>.articles:</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true"></a>            <span class="cf">return</span> []</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true"></a>        keyword_set <span class="op">=</span> {kw.lower() <span class="cf">for</span> kw <span class="kw">in</span> keywords <span class="cf">if</span> <span class="bu">len</span>(kw) <span class="op">&gt;</span> <span class="dv">2</span>}</span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true"></a>        scored <span class="op">=</span> []</span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true"></a>        <span class="cf">for</span> article <span class="kw">in</span> <span class="va">self</span>.articles:</span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true"></a>            text <span class="op">=</span> <span class="ss">f&quot;</span><span class="sc">{</span>article<span class="sc">.</span>get(<span class="st">&#39;title&#39;</span>, <span class="st">&#39;&#39;</span>)<span class="sc">}</span><span class="ss"> </span><span class="sc">{</span>article<span class="sc">.</span>get(<span class="st">&#39;description&#39;</span>, <span class="st">&#39;&#39;</span>)<span class="sc">}</span><span class="ss"> &quot;</span> \</span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true"></a>                   <span class="ss">f&quot;</span><span class="sc">{</span><span class="st">&#39; &#39;</span><span class="sc">.</span>join([t.get(<span class="st">&#39;term&#39;</span>, <span class="st">&#39;&#39;</span>) <span class="cf">if</span> <span class="bu">isinstance</span>(t, <span class="bu">dict</span>) <span class="cf">else</span> <span class="bu">str</span>(t) <span class="cf">for</span> t <span class="kw">in</span> article.get(<span class="st">&#39;categories&#39;</span>, [])])<span class="sc">}</span><span class="ss">&quot;</span>.lower()</span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true"></a>            score <span class="op">=</span> <span class="bu">sum</span>(<span class="dv">1</span> <span class="cf">for</span> kw <span class="kw">in</span> keyword_set <span class="cf">if</span> kw <span class="kw">in</span> text)</span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true"></a>            <span class="cf">if</span> score <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb86-11"><a href="#cb86-11" aria-hidden="true"></a>                scored.append((score, article))</span>
<span id="cb86-12"><a href="#cb86-12" aria-hidden="true"></a>        scored.sort(key<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="dv">0</span>], reverse<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb86-13"><a href="#cb86-13" aria-hidden="true"></a>        <span class="cf">return</span> [article <span class="cf">for</span> _, article <span class="kw">in</span> scored[:limit]]</span></code></pre></div>
<ul>
<li>Búsqueda por keywords en título, descripción y tags con scoring simple.</li>
</ul>
<div class="sourceCode" id="cb87"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true"></a>    <span class="kw">def</span> get_articles_by_category(<span class="va">self</span>, category: <span class="bu">str</span>, limit: <span class="bu">int</span> <span class="op">=</span> <span class="dv">3</span>) <span class="op">-&gt;</span> List[Dict]:</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true"></a>        category_keywords <span class="op">=</span> {</span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true"></a>            <span class="st">&quot;Legal and Financial&quot;</span>: [<span class="st">&quot;legal&quot;</span>, <span class="st">&quot;visa&quot;</span>, <span class="st">&quot;nie&quot;</span>, <span class="st">&quot;impuesto&quot;</span>, <span class="st">&quot;contrato&quot;</span>, <span class="st">&quot;bank&quot;</span>, <span class="st">&quot;immigration&quot;</span>],</span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true"></a>            <span class="st">&quot;Healthcare&quot;</span>: [<span class="st">&quot;salud&quot;</span>, <span class="st">&quot;doctor&quot;</span>, <span class="st">&quot;hospital&quot;</span>, <span class="st">&quot;dentista&quot;</span>, <span class="st">&quot;health&quot;</span>, <span class="st">&quot;medical&quot;</span>, <span class="st">&quot;clinic&quot;</span>],</span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true"></a>            <span class="st">&quot;Education&quot;</span>: [<span class="st">&quot;escuela&quot;</span>, <span class="st">&quot;colegio&quot;</span>, <span class="st">&quot;university&quot;</span>, <span class="st">&quot;idioma&quot;</span>, <span class="st">&quot;course&quot;</span>, <span class="st">&quot;school&quot;</span>, <span class="st">&quot;education&quot;</span>],</span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true"></a>            <span class="st">&quot;Accommodation&quot;</span>: [<span class="st">&quot;alojamiento&quot;</span>, <span class="st">&quot;hotel&quot;</span>, <span class="st">&quot;apartamento&quot;</span>, <span class="st">&quot;vivienda&quot;</span>, <span class="st">&quot;housing&quot;</span>, <span class="st">&quot;apartment&quot;</span>, <span class="st">&quot;rent&quot;</span>],</span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true"></a>            <span class="st">&quot;Restaurants&quot;</span>: [<span class="st">&quot;restaurante&quot;</span>, <span class="st">&quot;comida&quot;</span>, <span class="st">&quot;food&quot;</span>, <span class="st">&quot;restaurant&quot;</span>, <span class="st">&quot;dining&quot;</span>, <span class="st">&quot;cuisine&quot;</span>],</span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true"></a>            <span class="st">&quot;Arts and Culture&quot;</span>: [<span class="st">&quot;arte&quot;</span>, <span class="st">&quot;cultura&quot;</span>, <span class="st">&quot;museo&quot;</span>, <span class="st">&quot;gallery&quot;</span>, <span class="st">&quot;culture&quot;</span>, <span class="st">&quot;exhibition&quot;</span>],</span>
<span id="cb87-9"><a href="#cb87-9" aria-hidden="true"></a>            <span class="st">&quot;Work and Networking&quot;</span>: [<span class="st">&quot;trabajo&quot;</span>, <span class="st">&quot;empleo&quot;</span>, <span class="st">&quot;job&quot;</span>, <span class="st">&quot;networking&quot;</span>, <span class="st">&quot;business&quot;</span>, <span class="st">&quot;work&quot;</span>],</span>
<span id="cb87-10"><a href="#cb87-10" aria-hidden="true"></a>        }</span>
<span id="cb87-11"><a href="#cb87-11" aria-hidden="true"></a>        keywords <span class="op">=</span> category_keywords.get(category, [])</span>
<span id="cb87-12"><a href="#cb87-12" aria-hidden="true"></a>        <span class="cf">return</span> <span class="va">self</span>.search_articles(keywords, limit)</span></code></pre></div>
<ul>
<li>Mapeo manual de categorías → keywords; delega a <code>search_articles</code>.</li>
</ul>
<h3 id="errores-comunes-y-soluciones">7.3 Errores Comunes y Soluciones</h3>
<ul>
<li>Feed vacío/no accesible: revisar URL y conexión; ver logs <code>WARNING Feed vacío</code>.</li>
<li>Duplicados: se evita por URL; si un feed usa <code>id</code> distinto, se toma <code>link</code>.</li>
<li>Crecimiento infinito: límite 1000 artículos; ajustar en <code>config.py</code> si necesario.</li>
</ul>
<hr />
<h2 id="orquestador-principal-botsorchestrator.py">8. ORQUESTADOR PRINCIPAL (bots/orchestrator.py)</h2>
<h3 id="responsabilidades">8.1 Responsabilidades</h3>
<ul>
<li>Cargar base de datos de anunciantes.<br />
</li>
<li>Clasificar intención con embeddings y fallback de keywords.<br />
</li>
<li>Enrutar a bot especializado.<br />
</li>
<li>Enriquecer con guías y artículos.<br />
</li>
<li>Aplicar paginación <code>limit/offset</code> y devolver <code>has_more/next_offset</code>.</li>
</ul>
<h3 id="código-explicado-puntos-clave">8.2 Código Explicado (puntos clave)</h3>
<div class="sourceCode" id="cb88"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true"></a><span class="im">from</span> sentence_transformers <span class="im">import</span> SentenceTransformer, util</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true"></a><span class="im">from</span> .rss_manager <span class="im">import</span> get_rss_manager</span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true"></a><span class="im">from</span> config <span class="im">import</span> settings</span></code></pre></div>
<ul>
<li>Importa modelo de embeddings, RSS Manager y configuración.</li>
</ul>
<div class="sourceCode" id="cb89"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true"></a><span class="kw">class</span> Orchestrator:</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true"></a>        base_dir <span class="op">=</span> Path(<span class="va">__file__</span>).resolve().parent.parent</span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true"></a>        data_path <span class="op">=</span> base_dir <span class="op">/</span> <span class="st">&quot;data&quot;</span> <span class="op">/</span> <span class="st">&quot;anunciantes.json&quot;</span></span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true"></a>        <span class="cf">with</span> <span class="bu">open</span>(<span class="bu">str</span>(data_path), <span class="st">&#39;r&#39;</span>, encoding<span class="op">=</span><span class="st">&#39;utf-8&#39;</span>) <span class="im">as</span> f:</span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true"></a>            <span class="va">self</span>.advertisers <span class="op">=</span> json.load(f)</span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true"></a>        <span class="va">self</span>.content_manager <span class="op">=</span> ContentManager()</span>
<span id="cb89-8"><a href="#cb89-8" aria-hidden="true"></a>        <span class="va">self</span>.rss_manager <span class="op">=</span> get_rss_manager()</span>
<span id="cb89-9"><a href="#cb89-9" aria-hidden="true"></a>        <span class="va">self</span>.model <span class="op">=</span> SentenceTransformer(<span class="st">&#39;paraphrase-multilingual-MiniLM-L12-v2&#39;</span>)</span></code></pre></div>
<ul>
<li>Carga anunciantes y servicios auxiliares.<br />
</li>
<li>Inicia modelo multilingüe para embeddings.</li>
</ul>
<div class="sourceCode" id="cb90"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true"></a>        <span class="va">self</span>.category_patterns <span class="op">=</span> {<span class="st">&quot;es&quot;</span>: { ... }, <span class="st">&quot;en&quot;</span>: { ... }}</span></code></pre></div>
<ul>
<li>Palabras clave por idioma y categoría para fallback y tips.</li>
</ul>
<div class="sourceCode" id="cb91"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true"></a>        <span class="va">self</span>.bots_map <span class="op">=</span> {</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true"></a>            <span class="st">&quot;Accommodation&quot;</span>: acc_responder,</span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true"></a>            <span class="st">&quot;Legal and Financial&quot;</span>: leg_responder,</span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true"></a>            ...,</span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true"></a>            <span class="st">&quot;Restaurants&quot;</span>: generic_responder,</span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true"></a>        }</span></code></pre></div>
<ul>
<li>Mapa categoría → función <code>responder_consulta</code> del bot adecuado; genérico para categorías simples.</li>
</ul>
<div class="sourceCode" id="cb92"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true"></a>        <span class="va">self</span>.category_info <span class="op">=</span> []</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true"></a>        <span class="cf">for</span> category <span class="kw">in</span> all_categories:</span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true"></a>            description <span class="op">=</span> <span class="ss">f&quot;Servicios sobre </span><span class="sc">{</span>category<span class="sc">.</span>lower()<span class="sc">}</span><span class="ss">: &quot;</span> <span class="op">+</span> <span class="st">&quot;, &quot;</span>.join(keywords_es <span class="op">+</span> keywords_en)</span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true"></a>            <span class="va">self</span>.category_info.append({</span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true"></a>                <span class="st">&quot;name&quot;</span>: category,</span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true"></a>                <span class="st">&quot;description&quot;</span>: description,</span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true"></a>                <span class="st">&quot;embedding&quot;</span>: <span class="va">self</span>.model.encode(description, convert_to_tensor<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true"></a>            })</span></code></pre></div>
<ul>
<li>Precalcula embeddings por categoría para velocidad de clasificación.</li>
</ul>
<div class="sourceCode" id="cb93"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true"></a>    <span class="kw">def</span> classify_intent(<span class="va">self</span>, question, language<span class="op">=</span><span class="st">&quot;en&quot;</span>):</span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true"></a>        qn <span class="op">=</span> normalize(question)</span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true"></a>        question_embedding <span class="op">=</span> <span class="va">self</span>.model.encode(question, convert_to_tensor<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true"></a>        <span class="im">import</span> torch</span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true"></a>        category_embeddings <span class="op">=</span> torch.stack([cat[<span class="st">&quot;embedding&quot;</span>] <span class="cf">for</span> cat <span class="kw">in</span> <span class="va">self</span>.category_info])</span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true"></a>        cos_scores <span class="op">=</span> util.cos_sim(question_embedding, category_embeddings)[<span class="dv">0</span>]</span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true"></a>        top_result <span class="op">=</span> <span class="bu">int</span>(cos_scores.argmax().item())</span>
<span id="cb93-8"><a href="#cb93-8" aria-hidden="true"></a>        best_score <span class="op">=</span> <span class="bu">float</span>(cos_scores[top_result].item())</span>
<span id="cb93-9"><a href="#cb93-9" aria-hidden="true"></a>        best_match_category <span class="op">=</span> <span class="va">self</span>.category_info[top_result][<span class="st">&quot;name&quot;</span>]</span></code></pre></div>
<ul>
<li>Convierte pregunta a embedding, calcula similitud coseno y toma la categoría con mayor score.</li>
</ul>
<div class="sourceCode" id="cb94"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true"></a>        <span class="cf">for</span> category, businesses <span class="kw">in</span> <span class="va">self</span>.advertisers.items():</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true"></a>            <span class="cf">for</span> business <span class="kw">in</span> businesses:</span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true"></a>                name <span class="op">=</span> normalize(business.get(<span class="st">&#39;nombre&#39;</span>, <span class="st">&#39;&#39;</span>))</span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true"></a>                <span class="cf">if</span> name <span class="kw">and</span> name <span class="kw">in</span> qn:</span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true"></a>                    <span class="cf">return</span> category, <span class="fl">0.9</span>, business</span></code></pre></div>
<ul>
<li>Override por nombre explícito de negocio: prioridad absoluta si el usuario nombra un anunciante.</li>
</ul>
<div class="sourceCode" id="cb95"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true"></a>        kw_map <span class="op">=</span> <span class="va">self</span>.category_patterns.get(language, {})</span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true"></a>        best_kw_cat <span class="op">=</span> <span class="va">None</span><span class="op">;</span> best_hits <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true"></a>        <span class="cf">for</span> cat, kws <span class="kw">in</span> kw_map.items():</span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true"></a>            hits <span class="op">=</span> <span class="bu">sum</span>(<span class="dv">1</span> <span class="cf">for</span> kw <span class="kw">in</span> kws <span class="cf">if</span> kw <span class="kw">in</span> qn)</span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true"></a>            <span class="cf">if</span> hits <span class="op">&gt;</span> best_hits:</span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true"></a>                best_hits, best_kw_cat <span class="op">=</span> hits, cat</span>
<span id="cb95-7"><a href="#cb95-7" aria-hidden="true"></a>        <span class="cf">if</span> best_kw_cat <span class="kw">and</span> best_hits <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb95-8"><a href="#cb95-8" aria-hidden="true"></a>            <span class="cf">return</span> best_kw_cat, <span class="bu">max</span>(<span class="fl">0.25</span>, <span class="bu">min</span>(<span class="fl">0.9</span>, <span class="fl">0.15</span> <span class="op">*</span> best_hits <span class="op">+</span> <span class="fl">0.25</span>)), <span class="va">None</span></span></code></pre></div>
<ul>
<li>Fallback por keywords: calcula “confianza” basada en hits usando parámetros de <code>config.py</code> (modelo matemático sencillo: base + multiplicador).</li>
</ul>
<div class="sourceCode" id="cb96"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true"></a>        <span class="cf">if</span> best_score <span class="op">&gt;</span> <span class="fl">0.2</span>:</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true"></a>            <span class="cf">return</span> best_match_category, best_score, <span class="va">None</span></span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true"></a>        <span class="cf">else</span>:</span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true"></a>            <span class="cf">return</span> <span class="st">&quot;Desconocida&quot;</span>, best_score, <span class="va">None</span></span></code></pre></div>
<ul>
<li>Umbral de confianza: si la similitud es baja, marca como desconocido.</li>
</ul>
<div class="sourceCode" id="cb97"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true"></a>    <span class="kw">def</span> process_query(<span class="va">self</span>, question, language<span class="op">=</span><span class="st">&quot;en&quot;</span>, limit: <span class="bu">int</span> <span class="op">=</span> <span class="dv">3</span>, offset: <span class="bu">int</span> <span class="op">=</span> <span class="dv">0</span>):</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true"></a>        categoria, confidence, advertiser <span class="op">=</span> <span class="va">self</span>.classify_intent(question, language)</span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true"></a>        resultados <span class="op">=</span> <span class="va">self</span>.advertisers.get(categoria, [])</span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true"></a>        <span class="cf">if</span> advertiser <span class="kw">and</span> advertiser <span class="kw">not</span> <span class="kw">in</span> resultados:</span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true"></a>            resultados.insert(<span class="dv">0</span>, advertiser)</span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true"></a>        keywords <span class="op">=</span> [word.lower() <span class="cf">for</span> word <span class="kw">in</span> question.split() <span class="cf">if</span> <span class="bu">len</span>(word) <span class="op">&gt;</span> <span class="dv">3</span>]</span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true"></a>        guias_relevantes <span class="op">=</span> <span class="va">self</span>.content_manager.search_guides(keywords, categoria)</span>
<span id="cb97-8"><a href="#cb97-8" aria-hidden="true"></a>        articulos_revista <span class="op">=</span> <span class="va">self</span>.rss_manager.get_articles_by_category(categoria, limit<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb97-9"><a href="#cb97-9" aria-hidden="true"></a>        bot_response <span class="op">=</span> <span class="va">self</span>.bots_map[categoria](question, resultados, language<span class="op">=</span>lang)</span>
<span id="cb97-10"><a href="#cb97-10" aria-hidden="true"></a>        all_items <span class="op">=</span> bot_response.get(<span class="st">&quot;json_data&quot;</span>, [])</span>
<span id="cb97-11"><a href="#cb97-11" aria-hidden="true"></a>        total <span class="op">=</span> <span class="bu">len</span>(all_items)</span>
<span id="cb97-12"><a href="#cb97-12" aria-hidden="true"></a>        sliced <span class="op">=</span> all_items[offset:offset <span class="op">+</span> limit] <span class="cf">if</span> (limit <span class="kw">not</span> <span class="kw">in</span> (<span class="va">None</span>, <span class="dv">0</span>)) <span class="cf">else</span> all_items[offset:]</span>
<span id="cb97-13"><a href="#cb97-13" aria-hidden="true"></a>        has_more <span class="op">=</span> (offset <span class="op">+</span> (limit <span class="kw">or</span> <span class="dv">0</span>)) <span class="op">&lt;</span> total <span class="cf">if</span> limit <span class="kw">not</span> <span class="kw">in</span> (<span class="va">None</span>, <span class="dv">0</span>) <span class="cf">else</span> <span class="va">False</span></span>
<span id="cb97-14"><a href="#cb97-14" aria-hidden="true"></a>        next_offset <span class="op">=</span> (offset <span class="op">+</span> (limit <span class="kw">or</span> <span class="dv">0</span>)) <span class="cf">if</span> has_more <span class="cf">else</span> <span class="va">None</span></span></code></pre></div>
<ul>
<li>Enriquecimiento y paginación: slicing y cálculo de <code>has_more/next_offset</code>.</li>
</ul>
<h3 id="errores-y-soluciones">8.3 Errores y Soluciones</h3>
<ul>
<li>Modelo no instalado: ejecutar <code>pip install sentence-transformers torch</code>.<br />
</li>
<li><code>anunciantes.json</code> faltante: verificar ruta <code>data/anunciantes.json</code>.<br />
</li>
<li>Clasificación confusa: ajustar <code>CONFIDENCE_THRESHOLD</code> en <code>config.py</code>.</li>
</ul>
<hr />
<h2 id="bots-especializados">9. BOTS ESPECIALIZADOS</h2>
<p>Cada bot expone <code>responder_consulta(pregunta, anunciantes, language)</code> y retorna <code>{ key_points, json_data }</code>. La lógica común se apoya en utilidades compartidas.</p>
<h3 id="patrón-común">9.1 Patrón Común</h3>
<ul>
<li>Definir <code>keywords</code> por categoría.<br />
</li>
<li>Usar <code>filter_advertisers_by_keywords()</code> para priorizar sponsors con match.<br />
</li>
<li>Construir <code>key_points</code> con <code>build_key_points()</code>.<br />
</li>
<li>Retornar lista completa; el orquestador aplica paginación.</li>
</ul>
<h3 id="ejemplos">9.2 Ejemplos</h3>
<p>Bot Legal:</p>
<div class="sourceCode" id="cb98"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true"></a><span class="im">from</span> .utils <span class="im">import</span> filter_advertisers_by_keywords, build_key_points</span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true"></a><span class="kw">def</span> responder_consulta(pregunta, anunciantes, language<span class="op">=</span><span class="st">&quot;en&quot;</span>):</span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true"></a>    keywords <span class="op">=</span> [<span class="st">&quot;abogado&quot;</span>, <span class="st">&quot;legal&quot;</span>, <span class="st">&quot;impuestos&quot;</span>, <span class="st">&quot;nie&quot;</span>, <span class="st">&quot;visa&quot;</span>, <span class="st">&quot;bank&quot;</span>, ...]</span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true"></a>    selected <span class="op">=</span> filter_advertisers_by_keywords(pregunta, anunciantes, keywords)</span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true"></a>    key_points <span class="op">=</span> build_key_points(selected)</span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true"></a>    <span class="cf">return</span> {<span class="st">&quot;key_points&quot;</span>: key_points, <span class="st">&quot;json_data&quot;</span>: selected}</span></code></pre></div>
<p>Bot Healthcare (con integración Maps):</p>
<div class="sourceCode" id="cb99"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true"></a><span class="im">from</span> .maps_integration <span class="im">import</span> search_healthcare_barcelona</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true"></a>selected <span class="op">=</span> filter_advertisers_by_keywords(pregunta, anunciantes, keywords)</span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true"></a><span class="cf">for</span> advertiser <span class="kw">in</span> selected:</span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true"></a>    advertiser[<span class="st">&quot;es_anunciante&quot;</span>] <span class="op">=</span> <span class="va">True</span></span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true"></a><span class="cf">if</span> <span class="bu">len</span>(selected) <span class="op">&lt;</span> <span class="dv">3</span>:</span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true"></a>    search_term <span class="op">=</span> <span class="st">&quot;hospital&quot;</span>  <span class="co"># ajustado según la pregunta</span></span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true"></a>    maps_results <span class="op">=</span> search_healthcare_barcelona(search_term, limit<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb99-8"><a href="#cb99-8" aria-hidden="true"></a>    selected.extend(maps_results)</span>
<span id="cb99-9"><a href="#cb99-9" aria-hidden="true"></a><span class="cf">return</span> {<span class="st">&quot;key_points&quot;</span>: build_key_points(selected), <span class="st">&quot;json_data&quot;</span>: selected}</span></code></pre></div>
<p>Bot Accommodation:</p>
<div class="sourceCode" id="cb100"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true"></a>selected <span class="op">=</span> filter_advertisers_by_keywords(pregunta, anunciantes, keywords)</span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true"></a><span class="cf">return</span> {<span class="st">&quot;key_points&quot;</span>: build_key_points(selected), <span class="st">&quot;json_data&quot;</span>: selected}</span></code></pre></div>
<h3 id="soluciones-a-problemas-comunes">9.3 Soluciones a Problemas Comunes</h3>
<ul>
<li>Demasiados resultados irrelevantes: ajustar <code>keywords</code> y <code>search_fields</code> en <code>utils.filter_advertisers_by_keywords</code>.</li>
<li>Falta de <code>beneficios</code>: <code>build_key_points()</code> usa <code>[]</code> por defecto; completar datos en <code>anunciantes.json</code>.</li>
</ul>
<hr />
<h2 id="backend-api-main.py">10. BACKEND API (main.py)</h2>
<h3 id="setup">10.1 Setup</h3>
<ul>
<li>FastAPI con <code>lifespan</code> para scheduler.<br />
</li>
<li><code>BackgroundScheduler</code> de APScheduler para sync RSS cada 6 horas.<br />
</li>
<li>CORS abierto en desarrollo; restringir en producción.</li>
</ul>
<h3 id="modelos">10.2 Modelos</h3>
<div class="sourceCode" id="cb101"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true"></a><span class="kw">class</span> QueryRequest(BaseModel):</span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true"></a>    pregunta: <span class="bu">str</span> <span class="op">=</span> <span class="va">None</span></span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true"></a>    question: <span class="bu">str</span> <span class="op">=</span> <span class="va">None</span></span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true"></a>    language: <span class="bu">str</span> <span class="op">=</span> <span class="st">&quot;es&quot;</span></span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true"></a>    session_id: <span class="bu">str</span> <span class="op">=</span> <span class="va">None</span></span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true"></a>    limit: <span class="bu">int</span> <span class="op">|</span> <span class="va">None</span> <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true"></a>    offset: <span class="bu">int</span> <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb101-8"><a href="#cb101-8" aria-hidden="true"></a>    <span class="kw">def</span> get_question(<span class="va">self</span>):</span>
<span id="cb101-9"><a href="#cb101-9" aria-hidden="true"></a>        <span class="cf">return</span> <span class="va">self</span>.pregunta <span class="kw">or</span> <span class="va">self</span>.question <span class="kw">or</span> <span class="st">&quot;&quot;</span></span></code></pre></div>
<ul>
<li>Compatibilidad con <code>pregunta</code> y <code>question</code>.<br />
</li>
<li>Paginación: <code>limit/offset</code>.</li>
</ul>
<h3 id="endpoints">10.3 Endpoints</h3>
<ul>
<li><code>GET /api/health</code>: health check.<br />
</li>
<li><code>GET /api/categories</code>: categorías disponibles.<br />
</li>
<li><code>GET /api/sync-rss</code>: sincronización manual.<br />
</li>
<li><code>POST /api/query</code>: consulta principal, loguea, enruta y responde.<br />
</li>
<li><code>POST /api/analytics</code>: guarda eventos en <code>data/analytics/events.jsonl</code>.</li>
</ul>
<h3 id="errores-y-soluciones-1">10.4 Errores y Soluciones</h3>
<ul>
<li>500 en <code>/api/query</code>: revisar logs <code>ERROR en /api/query</code>; verificar que Orchestrator se inicializó.<br />
</li>
<li>CORS bloquea requests externos: configurar <code>allow_origins</code> con dominios permitidos.</li>
</ul>
<hr />
<h2 id="frontend-htmlcssjs">11. FRONTEND (HTML/CSS/JS)</h2>
<h3 id="index.html">11.1 index.html</h3>
<ul>
<li>Estructura con secciones: Header, Hero, Artículos, Guías, Servicios, Anunciantes, Newsletter, Footer.<br />
</li>
<li>Chat flotante (widget-like) integrado al final.<br />
</li>
<li>Carga <code>script.js</code> y <code>styles.css</code>.</li>
</ul>
<h3 id="styles.css">11.2 styles.css</h3>
<ul>
<li>Variables CSS, diseño responsivo, componentes estilizados (cards, carrusel, chat).<br />
</li>
<li>Optimizado para lectura y acciones (CTAs destacadas).</li>
</ul>
<h3 id="script.js-puntos-clave">11.3 script.js (puntos clave)</h3>
<ul>
<li><code>sendQuery()</code>: envía POST con <code>{question, language, limit, offset}</code>; maneja errores con diagnóstico en consola.<br />
</li>
<li><code>updateBotMessage()</code>: renderiza respuesta, guías, artículos RSS, resultados, botón “Mostrar más”, y tracking de clics.<br />
</li>
<li>Paginación: mantiene <code>lastQuery</code> y <code>nextOffset</code> para cargar más resultados.<br />
</li>
<li>FAQ desplegable: acordeón interactivo por anunciante.<br />
</li>
<li>Quick actions: botones predefinidos para categorías frecuentes.</li>
</ul>
<hr />
<h2 id="widget-embebible-widget.js-embed.js">12. WIDGET EMBEBIBLE (widget.js / embed.js)</h2>
<h3 id="embed.js">12.1 embed.js</h3>
<ul>
<li>Carga <code>widget.css</code> y <code>widget.js</code> desde el dominio de la API.<br />
</li>
<li>Inicializa el widget con <code>ExpatAssistantWidget(config)</code>.</li>
</ul>
<h3 id="widget.js">12.2 widget.js</h3>
<ul>
<li>Clase <code>ExpatAssistantWidget</code> con configuración (API URL, color, sugerencias).<br />
</li>
<li>Métodos: <code>init()</code>, <code>createWidget()</code>, <code>attachEventListeners()</code>, <code>sendMessage()</code>, <code>addAdvertisers()</code>, <code>addGuides()</code>, <code>trackEvent()</code>.</li>
<li>Renderiza mensajes, muestra typing indicator y envía requests a <code>/api/query</code>.<br />
</li>
<li>Integra tracking (Google Analytics, Meta Pixel y backend propio).</li>
</ul>
<h3 id="consideraciones">12.3 Consideraciones</h3>
<ul>
<li>Personalizable vía <code>window.ExpatAssistantConfig</code>.<br />
</li>
<li>Se puede montar en cualquier sitio externo sin conflictos.</li>
</ul>
<hr />
<h2 id="evolución-y-mejoras">13. EVOLUCIÓN Y MEJORAS</h2>
<ul>
<li>Integración RSS con caché y scheduler.<br />
</li>
<li>Paginación <code>limit/offset</code> + botón “Mostrar más” en frontend.<br />
</li>
<li>Configuración centralizada con <code>config.py</code> (Pydantic BaseSettings).<br />
</li>
<li>Logging estructurado con <code>bots/logger.py</code>.<br />
</li>
<li>DRY: <code>build_key_points()</code> y <code>filter_advertisers_by_keywords()</code> en <code>utils.py</code>.<br />
</li>
<li>Limpieza de dependencias (Flask removido, FastAPI activo).<br />
</li>
<li>Guías editoriales y tips por categoría.</li>
</ul>
<hr />
<h2 id="troubleshooting">14. TROUBLESHOOTING</h2>
<ul>
<li>“El feed no sincroniza”: probar <code>GET /api/sync-rss</code>; verificar conectividad; revisar logs.<br />
</li>
<li>“Error de clasificación”: bajar/ajustar <code>CONFIDENCE_THRESHOLD</code> en <code>config.py</code>.<br />
</li>
<li>“CORS bloqueado”: configurar <code>allow_origins</code> en <code>main.py</code> con dominios reales.<br />
</li>
<li>“Sin anunciantes”: comprobar <code>data/anunciantes.json</code> y formato de campos; ajustar <code>search_fields</code>.</li>
</ul>
<hr />
<h2 id="conclusiones">15. CONCLUSIONES</h2>
<ul>
<li>Arquitectura modular, escalable y mantenible.<br />
</li>
<li>Experiencia de usuario rica: recomendaciones + contenido editorial + paginación.<br />
</li>
<li>Preparado para producción con logging, config central y scheduler.</li>
</ul>
<hr />
<h2 id="exportar-a-pdf">16. EXPORTAR A PDF</h2>
<p>Opciones para generar el PDF desde este reporte:</p>
<ul>
<li>Usando <code>pandoc</code> (recomendado):
<ul>
<li>Instalar: <code>sudo apt-get install pandoc wkhtmltopdf</code> (opcional para PDF via HTML).<br />
</li>
<li>Comando: <code>pandoc REPORTE_PROYECTO_COMPLETO.md -o REPORTE_Revista_Expats_AI.pdf</code>.</li>
</ul></li>
<li>Usando <code>wkhtmltopdf</code> (si prefieres render HTML):
<ul>
<li><code>wkhtmltopdf REPORTE_PROYECTO_COMPLETO.md REPORTE_Revista_Expats_AI.pdf</code> (requiere convertir Markdown a HTML primero: <code>pandoc -s REPORTE_PROYECTO_COMPLETO.md -o reporte.html</code> y luego <code>wkhtmltopdf reporte.html reporte.pdf</code>).</li>
</ul></li>
</ul>
<p>Sugerencia: incluye cabecera/portada con <code>--metadata</code> en pandoc y estilo CSS para una salida profesional.</p>
<hr />
<h2 id="anexo-código-clave-incluido">17. ANEXO: CÓDIGO CLAVE INCLUIDO</h2>
<p>Para referencia rápida, se han explicado y mostrado los fragmentos críticos en las secciones anteriores:<br />
- Configuración central: <code>config.py</code>.<br />
- Logger: <code>bots/logger.py</code>.<br />
- Utilidades: <code>bots/utils.py</code>.<br />
- Gestor RSS: <code>bots/rss_manager.py</code>.<br />
- Orquestador: <code>bots/orchestrator.py</code>.<br />
- Bots (Legal, Healthcare, Accommodation).<br />
- Backend FastAPI: <code>main.py</code>.<br />
- Frontend: <code>frontend/index.html</code>, <code>frontend/script.js</code>, <code>frontend/styles.css</code>.<br />
- Widget: <code>widget/embed.js</code>, <code>widget/widget.js</code>, <code>widget/widget.css</code>.</p>
<p>Si deseas añadir un “Anexo B” con el listado completo de todos los archivos del repositorio (contenido íntegro), puedo incorporarlo automáticamente en este documento antes de exportar a PDF.</p>
</body>
</html>
